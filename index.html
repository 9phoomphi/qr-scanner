<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Document Control</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    :root {
      --bg: #f3f6fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --border: #dbe4f0;
      --primary: #2563eb;
      --primary-2: #1d4ed8;
      --danger: #dc2626;
      --success: #15803d;
      --warning: #b45309;
      --shadow: 0 16px 38px rgba(15, 23, 42, 0.10);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "IBM Plex Sans Thai", "Noto Sans Thai", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, #dbeafe, rgba(219, 234, 254, 0)), var(--bg);
      min-height: 100vh;
    }

    .shell {
      max-width: 1220px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      gap: 14px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .title {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 800;
      letter-spacing: 0.01em;
    }

    .muted { color: var(--muted); }

    .row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .row.three {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .field {
      display: grid;
      gap: 5px;
    }

    .field.full { grid-column: 1 / -1; }

    label {
      font-size: 0.83rem;
      color: var(--muted);
      font-weight: 600;
    }

    input, select {
      height: 40px;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0 12px;
      font: inherit;
      color: var(--text);
      background: #fff;
    }

    .btn {
      border: none;
      height: 38px;
      border-radius: 999px;
      padding: 0 14px;
      font: inherit;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      background: linear-gradient(180deg, var(--primary), var(--primary-2));
    }

    .btn.secondary { background: #334155; }
    .btn.success { background: #15803d; }
    .btn.danger { background: var(--danger); }
    .btn.outline {
      color: var(--primary-2);
      background: #fff;
      border: 1px solid #93c5fd;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.80rem;
      font-weight: 700;
      border: 1px solid var(--border);
      color: var(--muted);
      background: #f8fbff;
    }

    .status-pill.ok {
      color: var(--success);
      border-color: rgba(21, 128, 61, 0.28);
      background: rgba(21, 128, 61, 0.08);
    }

    .status-pill.warn {
      color: var(--warning);
      border-color: rgba(180, 83, 9, 0.28);
      background: rgba(180, 83, 9, 0.08);
    }

    .status-pill.error {
      color: var(--danger);
      border-color: rgba(220, 38, 38, 0.28);
      background: rgba(220, 38, 38, 0.08);
    }

    .hidden { display: none !important; }

    .alert {
      border: 1px solid rgba(220, 38, 38, 0.24);
      background: rgba(220, 38, 38, 0.08);
      color: var(--danger);
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 0.88rem;
    }

    .tabs {
      display: inline-flex;
      gap: 6px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #f8fbff;
      padding: 4px;
      margin-bottom: 10px;
    }

    .tab-btn {
      border: none;
      border-radius: 999px;
      height: 32px;
      padding: 0 12px;
      cursor: pointer;
      font: inherit;
      font-size: .86rem;
      font-weight: 700;
      color: #334155;
      background: transparent;
    }

    .tab-btn.active {
      color: #1d4ed8;
      background: #dbeafe;
    }

    .table-wrap {
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 980px;
      background: #fff;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 9px 10px;
      text-align: left;
      font-size: 0.87rem;
      vertical-align: top;
    }

    th {
      background: #f8fbff;
      color: #334155;
      font-weight: 800;
      white-space: nowrap;
    }

    tr:hover td {
      background: #f8fbff;
    }

    .status-badge {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.76rem;
      font-weight: 700;
      border: 1px solid var(--border);
      background: #f8fbff;
      color: #334155;
      white-space: nowrap;
    }

    .status-badge.stored {
      border-color: rgba(21, 128, 61, 0.32);
      color: var(--success);
      background: rgba(21, 128, 61, 0.08);
    }

    .pager {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .login-wrap {
      width: min(560px, 100%) !important;
      margin: 0 auto;
      padding: 24px 22px 20px !important;
      border-radius: 32px !important;
      background: rgba(255, 255, 255, 0.52) !important;
      border: 1px solid rgba(255, 255, 255, 0.68) !important;
      backdrop-filter: saturate(165%) blur(24px) !important;
      -webkit-backdrop-filter: saturate(165%) blur(24px) !important;
      box-shadow: 0 22px 56px rgba(15, 23, 42, 0.14) !important;
    }

    .login-stage {
      width: 100%;
      display: grid;
      gap: 10px;
      justify-items: center;
      padding: 2px 0;
    }

    .login-brand {
      width: 100%;
      display: grid;
      grid-template-columns: auto minmax(0, 1fr);
      align-items: flex-start;
      column-gap: 12px;
      margin-bottom: 10px;
      padding: 0 2px 6px;
    }

    .login-brand-copy {
      min-width: 0;
      display: grid;
      gap: 4px;
      padding-top: 3px;
    }

    .login-shield {
      position: relative;
      width: 82px;
      height: 82px;
      border-radius: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 1.62rem;
      background: linear-gradient(180deg, #59b3ff 0%, #0a84ff 58%, #0064d2 100%);
      box-shadow: 0 14px 32px rgba(10, 132, 255, 0.30);
      flex: 0 0 auto;
    }

    .login-shield::after {
      content: "";
      position: absolute;
      inset: 2px;
      border-radius: inherit;
      border: 1px solid rgba(255, 255, 255, 0.38);
      pointer-events: none;
    }

    .login-kicker {
      margin: 0;
      color: #5f6c80;
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      font-weight: 700;
      text-transform: uppercase;
      line-height: 1.2;
    }

    .login-title {
      margin: 0;
      color: #111827;
      font-size: 2.3rem;
      font-weight: 700;
      line-height: 1.05;
      letter-spacing: -0.01em;
    }

    .login-subtitle {
      margin: 2px 0 0;
      color: #64748b;
      font-size: 0.94rem;
      line-height: 1.4;
      font-weight: 600;
      max-width: 34ch;
    }

    .login-form .field {
      gap: 6px;
      margin-bottom: 9px;
    }

    .login-form label {
      color: #6b7280;
      font-size: 0.78rem;
      letter-spacing: 0.02em;
      text-transform: none;
      font-weight: 700;
    }

    .login-input {
      display: block;
      width: 100% !important;
      min-width: 0;
      height: 56px !important;
      border-radius: 22px !important;
      border: 1px solid rgba(148, 163, 184, 0.4) !important;
      background: rgba(255, 255, 255, 0.8) !important;
      color: #111827 !important;
      padding: 0 18px !important;
      font-size: 1.04rem;
      font-weight: 600;
    }

    .login-input::placeholder {
      color: rgba(17, 24, 39, 0.46) !important;
      font-weight: 600;
    }

    .login-input:focus {
      border-color: rgba(10, 132, 255, 0.65) !important;
      box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.14) !important;
    }

    .pass-wrap {
      position: relative;
      width: 100%;
    }

    .pass-wrap .login-input {
      padding-right: 52px !important;
    }

    .pass-eye {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 10px;
      background: transparent;
      color: #6b7280;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.05rem;
      cursor: pointer;
    }

    .pass-eye:hover {
      background: rgba(10, 132, 255, 0.12);
      color: #0a84ff;
    }

    .login-submit {
      margin-top: 10px;
      width: 100%;
      height: 58px !important;
      border-radius: 999px !important;
      font-size: 1rem !important;
      font-weight: 800 !important;
      letter-spacing: 0;
    }

    .login-foot {
      margin-top: 12px;
      text-align: center;
      color: #6b7280;
      font-size: 0.73rem;
      letter-spacing: 0.12em;
      font-weight: 700;
      text-transform: none;
    }

    body.login-mode {
      min-height: 100vh;
    }

    body.login-mode .shell {
      width: min(1160px, 100%) !important;
      max-width: none !important;
      min-height: 100vh !important;
      display: flex !important;
      flex-direction: column !important;
      justify-content: center !important;
      align-items: center !important;
      gap: 10px;
      padding: 24px 14px !important;
    }

    body.login-mode #homeTopbar {
      display: none !important;
    }

    body.login-mode #appCard {
      display: none !important;
    }

    body.login-mode #settingsCard,
    body.login-mode #errorBox {
      width: min(560px, 100%);
      margin: 0 auto;
    }

    body.login-mode #settingsCard {
      border-radius: 22px;
      background: rgba(255, 255, 255, 0.5);
    }

    body.login-mode #errorBox {
      border-radius: 14px;
      background: rgba(220, 38, 38, 0.1);
    }

    /* login-mode: lock contrast and spacing so theme override does not wash text out */
    body.login-mode #loginCard.login-wrap {
      background: rgba(255, 255, 255, 0.58) !important;
      border-color: rgba(255, 255, 255, 0.72) !important;
      box-shadow: 0 24px 58px rgba(15, 23, 42, 0.16) !important;
    }

    body.login-mode #loginCard .login-kicker,
    body.login-mode #loginCard .login-subtitle,
    body.login-mode #loginCard .login-form label,
    body.login-mode #loginCard .login-foot {
      color: #5f6b7d !important;
    }

    body.login-mode #loginCard .login-title {
      color: #0f172a !important;
    }

    body.login-mode #loginCard .login-input {
      background: rgba(255, 255, 255, 0.88) !important;
      border-color: rgba(148, 163, 184, 0.5) !important;
      color: #111827 !important;
    }

    body.login-mode #loginCard .login-input::placeholder {
      color: rgba(100, 116, 139, 0.86) !important;
    }

    body.login-mode #loginCard .pass-eye {
      color: #6b7280 !important;
    }

    body.login-mode #loginCard .pass-eye:hover {
      background: rgba(10, 132, 255, 0.12) !important;
      color: #0a84ff !important;
    }

    body.login-mode.dark-mode #loginCard.login-wrap {
      background: rgba(13, 21, 33, 0.74) !important;
      border-color: rgba(148, 163, 184, 0.34) !important;
      box-shadow: 0 36px 88px rgba(2, 8, 20, 0.62) !important;
    }

    body.login-mode.dark-mode #loginCard .login-kicker,
    body.login-mode.dark-mode #loginCard .login-subtitle,
    body.login-mode.dark-mode #loginCard .login-form label,
    body.login-mode.dark-mode #loginCard .login-foot {
      color: rgba(226, 232, 240, 0.84) !important;
    }

    body.login-mode.dark-mode #loginCard .login-title {
      color: #f8fafc !important;
    }

    body.login-mode.dark-mode #loginCard .login-input {
      background: rgba(15, 23, 42, 0.84) !important;
      border-color: rgba(148, 163, 184, 0.5) !important;
      color: #f8fafc !important;
    }

    body.login-mode.dark-mode #loginCard .login-input::placeholder {
      color: rgba(203, 213, 225, 0.72) !important;
    }

    body.login-mode.dark-mode #loginCard .pass-eye {
      color: rgba(226, 232, 240, 0.86) !important;
    }

    body.login-mode.dark-mode #loginCard .pass-eye:hover {
      background: rgba(125, 211, 252, 0.2) !important;
      color: #8dd8ff !important;
    }

    body.login-mode.dark-mode #settingsCard {
      background: rgba(15, 23, 42, 0.64) !important;
      border-color: rgba(148, 163, 184, 0.34) !important;
    }

    body.login-mode.dark-mode #errorBox {
      background: rgba(127, 29, 29, 0.38) !important;
      border-color: rgba(248, 113, 113, 0.5) !important;
      color: #fecaca !important;
    }

    .empty {
      padding: 16px;
      text-align: center;
      color: var(--muted);
      font-weight: 600;
    }

    .settings-grid {
      display: grid;
      gap: 10px;
    }

    .link-btn {
      color: var(--primary);
      text-decoration: none;
      font-weight: 700;
      white-space: nowrap;
    }

    .link-btn:hover { text-decoration: underline; }

    .config-links {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .config-link {
      display: inline-flex;
      align-items: center;
      height: 28px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.80rem;
      color: #1e3a8a;
      text-decoration: none;
      background: #eff6ff;
      font-weight: 700;
    }

    .config-link:hover {
      text-decoration: underline;
      background: #dbeafe;
    }

    .box-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    .box-card {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #f8fbff;
      padding: 12px;
      text-decoration: none;
      color: inherit;
      transition: transform .16s ease, box-shadow .2s ease;
    }

    .box-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(15,23,42,.12);
    }

    .box-name {
      font-size: .96rem;
      font-weight: 800;
      color: #1d4ed8;
      word-break: break-word;
    }

    .box-count {
      margin-top: 3px;
      color: #475569;
      font-size: .82rem;
      font-weight: 700;
    }

    @media (max-width: 1100px) {
      .box-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    @media (max-width: 900px) {
      .row, .row.three { grid-template-columns: 1fr; }
      .shell { padding: 10px; }
      .box-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 560px) {
      .box-grid { grid-template-columns: 1fr; }
      .login-wrap {
        padding: 18px 12px 14px;
        border-radius: 24px;
      }
      .login-brand {
        column-gap: 8px;
        margin-bottom: 8px;
        padding: 0 1px 4px;
      }
      .login-shield {
        width: 62px;
        height: 62px;
        border-radius: 20px;
        font-size: 1.08rem;
      }
      .login-title {
        font-size: 1.72rem;
        line-height: 1.06;
      }
      .login-subtitle {
        margin-top: 2px;
        font-size: 0.82rem;
        line-height: 1.32;
      }
      .login-kicker {
        font-size: 0.6rem;
        letter-spacing: 0.16em;
      }
      .login-input {
        height: 50px !important;
        border-radius: 18px !important;
      }
      .login-submit {
        height: 52px !important;
        font-size: 1.02rem;
      }
    }
  </style>
  <link rel="stylesheet" href="./theme-legacy.css">
</head>
<body>
  <div class="shell">
    <div id="homeTopbar" class="card topbar">
      <div>
        <h1 id="appTitle" class="title">ระบบทะเบียนคุมเอกสาร (GitHub Frontend)</h1>
        <div id="appSubtitle" class="muted" style="font-size:0.85rem;">พร้อมใช้งานกับ Apps Script API</div>
        <div id="configLinks" class="config-links hidden">
          <a id="linkWebApp" class="config-link hidden" target="_blank" rel="noopener">Web App</a>
          <a id="linkSpreadsheet" class="config-link hidden" target="_blank" rel="noopener">Spreadsheet</a>
          <a id="linkAppsScript" class="config-link hidden" target="_blank" rel="noopener">Apps Script</a>
          <a id="linkDriveFolder" class="config-link hidden" target="_blank" rel="noopener">Drive Folder</a>
          <a id="linkManual" class="config-link hidden" target="_blank" rel="noopener">คู่มือ</a>
        </div>
      </div>
      <div class="actions">
        <span id="connectStatus" class="status-pill">ยังไม่ได้ตั้งค่า API</span>
        <button id="btnOpenSettings" class="btn secondary" type="button">ตั้งค่า API</button>
        <button id="btnLogout" class="btn danger hidden" type="button">ออกจากระบบ</button>
      </div>
    </div>

    <div id="settingsCard" class="card hidden">
      <div class="settings-grid">
        <div class="field full">
          <label for="scriptUrl">Apps Script Web App URL (/exec)</label>
          <input id="scriptUrl" placeholder="วางลิงก์ Web App ที่ลงท้ายด้วย /exec" />
        </div>
        <div class="field">
          <label for="deviceKey">Device Key (ระบบสร้างให้อัตโนมัติได้)</label>
          <input id="deviceKey" placeholder="dk_xxxxxxxxx" />
        </div>
        <div class="actions">
          <button id="btnGenerateDevice" class="btn secondary" type="button">สุ่ม Device Key</button>
          <button id="btnSaveSettings" class="btn" type="button">บันทึกการตั้งค่า</button>
        </div>
        <div class="muted" style="font-size:0.82rem;">
          ตั้งค่าครั้งเดียว ระบบจะจำไว้ในเบราว์เซอร์เครื่องนี้
        </div>
      </div>
    </div>

    <div id="errorBox" class="alert hidden"></div>

    <div id="loginCard" class="card login-wrap hidden">
      <div class="login-stage">
        <div class="login-brand">
          <div class="login-shield"><i class="bi bi-shield-lock-fill"></i></div>
          <div class="login-brand-copy">
            <p class="login-kicker">Document Control</p>
            <h2 class="login-title">เข้าสู่ระบบ</h2>
            <p class="login-subtitle">ยินดีต้อนรับกลับมา กรุณายืนยันตัวตนเพื่อใช้งาน</p>
          </div>
        </div>

        <div class="login-form" style="width:100%;">
          <div class="field full">
            <label for="username">Username</label>
            <input id="username" class="login-input" placeholder="Username" autocomplete="username" />
          </div>
          <div class="field full">
            <label for="password">Password</label>
            <div class="pass-wrap">
              <input id="password" class="login-input" type="password" placeholder="Password" autocomplete="current-password" />
              <button id="btnTogglePassword" class="pass-eye" type="button" aria-label="แสดง/ซ่อนรหัสผ่าน">
                <i id="passwordEyeIcon" class="bi bi-eye"></i>
              </button>
            </div>
          </div>

          <button id="btnLogin" class="btn login-submit" type="button">
            <i class="bi bi-box-arrow-in-right"></i> เข้าสู่ระบบ
          </button>
        </div>

        <div class="login-foot">Secure Access</div>
      </div>
    </div>

    <div id="appCard" class="card hidden">
      <div class="topbar" style="margin-bottom:10px;">
        <div>
          <div class="muted" style="font-size:0.82rem;">ผู้ใช้งาน</div>
          <div id="userLabel" style="font-weight:800;">-</div>
        </div>
        <div class="actions">
          <button id="btnAdd" class="btn" type="button">เพิ่มเอกสาร</button>
          <button id="btnBoxScan" class="btn" type="button">สแกนจัดเก็บ</button>
          <button id="btnInspection" class="btn secondary" type="button">ตรวจสอบผลงาน</button>
          <button id="btnRefresh" class="btn outline" type="button">รีเฟรช</button>
        </div>
      </div>

      <div class="tabs">
        <button id="tabDocs" class="tab-btn active" type="button">รายการเอกสาร</button>
        <button id="tabBoxes" class="tab-btn" type="button">ตรวจสอบกล่อง</button>
      </div>

      <div id="docsTab">
        <div class="card" style="margin-bottom:10px;">
          <div id="statsRow" class="stats-grid"></div>
        </div>

        <div class="row three" style="margin-bottom:10px;">
          <div class="field">
            <label for="searchQuery">ค้นหา</label>
            <input id="searchQuery" placeholder="เลขที่หนังสือ, เรื่อง, ผู้ส่ง" />
          </div>
          <div class="field">
            <label for="statusFilter">สถานะ</label>
            <select id="statusFilter">
              <option value="all">ทั้งหมด</option>
              <option value="inprogress">กำลังดำเนินการ</option>
              <option value="assigned">มอบผู้รับผิดชอบ</option>
              <option value="completed">ดำเนินการเสร็จ</option>
              <option value="stored">จัดเก็บแล้ว</option>
              <option value="pending">รอจัดเก็บ</option>
              <option value="returned">อนุมัติแล้วส่งคืนเจ้าของเรื่อง</option>
              <option value="cancelled">ยกเลิก</option>
            </select>
          </div>
          <div class="field">
            <label for="itemsPerPage">จำนวนต่อหน้า</label>
            <select id="itemsPerPage">
              <option value="20">20</option>
              <option value="30">30</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>

        <div class="actions" style="margin-bottom:10px;">
          <button id="btnSearch" class="btn" type="button">ค้นหา</button>
          <button id="btnPrintAll" class="btn success" type="button">พิมพ์รายงานทั้งหมด</button>
        </div>

        <div id="docsList" class="docs-list">
          <div class="empty">ยังไม่มีข้อมูล</div>
        </div>

        <div class="pager">
          <div id="pageInfo" class="muted">หน้า 1 / 1 (0 รายการ)</div>
          <div class="actions">
            <button id="btnPrev" class="btn secondary" type="button">ก่อนหน้า</button>
            <button id="btnNext" class="btn secondary" type="button">ถัดไป</button>
          </div>
        </div>
      </div>

      <div id="boxesTab" class="hidden">
        <div class="topbar" style="margin-bottom:10px;">
          <div class="muted" id="boxSummaryLabel">กล่องเอกสารที่มีการจัดเก็บ</div>
          <button id="btnReloadBoxes" class="btn outline" type="button">รีโหลดข้อมูลกล่อง</button>
        </div>
        <div id="boxesWrap" class="box-grid"></div>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script src="./api-client.js"></script>
  <script src="./theme-legacy.js"></script>
  <script src="./app-common.js"></script>
  <script>
    (function () {
      'use strict';

      var C = window.DocFrontendCommon;

      var state = {
        api: null,
        user: null,
        config: null,
        page: 1,
        itemsPerPage: 20,
        totalPages: 1,
        totalItems: 0,
        searchQuery: '',
        statusFilter: 'all',
        loading: false,
        settings: null,
        boxSummary: [],
        lastSystemReport: null
      };

      var els = {
        appTitle: document.getElementById('appTitle'),
        appSubtitle: document.getElementById('appSubtitle'),
        configLinks: document.getElementById('configLinks'),
        linkWebApp: document.getElementById('linkWebApp'),
        linkSpreadsheet: document.getElementById('linkSpreadsheet'),
        linkAppsScript: document.getElementById('linkAppsScript'),
        linkDriveFolder: document.getElementById('linkDriveFolder'),
        linkManual: document.getElementById('linkManual'),
        connectStatus: document.getElementById('connectStatus'),
        btnOpenSettings: document.getElementById('btnOpenSettings'),
        btnLogout: document.getElementById('btnLogout'),
        settingsCard: document.getElementById('settingsCard'),
        scriptUrl: document.getElementById('scriptUrl'),
        deviceKey: document.getElementById('deviceKey'),
        btnGenerateDevice: document.getElementById('btnGenerateDevice'),
        btnSaveSettings: document.getElementById('btnSaveSettings'),
        errorBox: document.getElementById('errorBox'),
        loginCard: document.getElementById('loginCard'),
        username: document.getElementById('username'),
        password: document.getElementById('password'),
        btnTogglePassword: document.getElementById('btnTogglePassword'),
        passwordEyeIcon: document.getElementById('passwordEyeIcon'),
        btnLogin: document.getElementById('btnLogin'),
        appCard: document.getElementById('appCard'),
        userLabel: document.getElementById('userLabel'),
        btnAdd: document.getElementById('btnAdd'),
        btnBoxScan: document.getElementById('btnBoxScan'),
        btnInspection: document.getElementById('btnInspection'),
        btnRefresh: document.getElementById('btnRefresh'),
        tabDocs: document.getElementById('tabDocs'),
        tabBoxes: document.getElementById('tabBoxes'),
        docsTab: document.getElementById('docsTab'),
        boxesTab: document.getElementById('boxesTab'),
        searchQuery: document.getElementById('searchQuery'),
        statusFilter: document.getElementById('statusFilter'),
        itemsPerPage: document.getElementById('itemsPerPage'),
        btnSearch: document.getElementById('btnSearch'),
        btnPrintAll: document.getElementById('btnPrintAll'),
        statsRow: document.getElementById('statsRow'),
        docsList: document.getElementById('docsList'),
        pageInfo: document.getElementById('pageInfo'),
        btnPrev: document.getElementById('btnPrev'),
        btnNext: document.getElementById('btnNext'),
        btnReloadBoxes: document.getElementById('btnReloadBoxes'),
        boxSummaryLabel: document.getElementById('boxSummaryLabel'),
        boxesWrap: document.getElementById('boxesWrap')
      };

      function showError(message) {
        var msg = C.safeTrim(message || '');
        if (!msg) {
          els.errorBox.classList.add('hidden');
          els.errorBox.textContent = '';
          return;
        }
        els.errorBox.textContent = msg;
        els.errorBox.classList.remove('hidden');
      }

      function setStatus(label, type) {
        els.connectStatus.textContent = label;
        els.connectStatus.className = 'status-pill ' + (type || '');
      }

      function setLoading(isLoading) {
        state.loading = !!isLoading;
        els.btnLogin.disabled = state.loading;
        if (els.btnTogglePassword) els.btnTogglePassword.disabled = state.loading;
        els.btnSaveSettings.disabled = state.loading;
        els.btnSearch.disabled = state.loading;
        els.btnRefresh.disabled = state.loading;
        els.btnPrintAll.disabled = state.loading;
        els.btnReloadBoxes.disabled = state.loading;
        els.btnPrev.disabled = state.loading || state.page <= 1;
        els.btnNext.disabled = state.loading || state.page >= state.totalPages;
      }

      function bindConfigLinks(config) {
        var links = (config && config.links) ? config.links : {};
        var hasAnyLink = false;

        function bindLink(el, url) {
          if (!url) {
            el.classList.add('hidden');
            el.removeAttribute('href');
            return;
          }
          hasAnyLink = true;
          el.href = url;
          el.classList.remove('hidden');
        }

        bindLink(els.linkWebApp, links.webApp || config.scriptUrl || '');
        bindLink(els.linkSpreadsheet, links.spreadsheet || '');
        bindLink(els.linkAppsScript, links.appsScriptProject || '');
        bindLink(els.linkDriveFolder, links.driveFolder || '');
        bindLink(els.linkManual, links.manual || '');

        els.configLinks.classList.toggle('hidden', !hasAnyLink);
      }

      function applyConfigToUI(config) {
        if (config.appName) els.appTitle.textContent = config.appName;
        if (config.subtitle) els.appSubtitle.textContent = config.subtitle;
        bindConfigLinks(config);
      }

      function applyLockMode(config) {
        if (!config.lockSettings) return;
        els.btnOpenSettings.classList.add('hidden');
        els.btnGenerateDevice.classList.add('hidden');
        els.btnSaveSettings.classList.add('hidden');
        els.scriptUrl.readOnly = true;
        els.deviceKey.readOnly = true;
        els.settingsCard.classList.add('hidden');
      }

      function switchTab(name) {
        var isDocs = name !== 'boxes';
        els.tabDocs.classList.toggle('active', isDocs);
        els.tabBoxes.classList.toggle('active', !isDocs);
        els.docsTab.classList.toggle('hidden', !isDocs);
        els.boxesTab.classList.toggle('hidden', isDocs);
      }

      function setLoggedIn(user) {
        state.user = user || null;

        if (state.user) {
          document.body.classList.remove('login-mode');
          var name = C.safeText(state.user.displayName || state.user.username || '-');
          var role = C.safeText(state.user.accessRoleLabel || '');
          els.userLabel.textContent = role ? (name + ' (' + role + ')') : name;
          els.loginCard.classList.add('hidden');
          els.appCard.classList.remove('hidden');
          els.btnLogout.classList.remove('hidden');
          setStatus('เชื่อมต่อแล้ว', 'ok');

          var isReadOnly = !!(state.user.isReadOnly || state.user.canEdit === false);
          els.btnAdd.classList.toggle('hidden', isReadOnly);
          els.btnBoxScan.classList.toggle('hidden', isReadOnly);

          return;
        }

        document.body.classList.add('login-mode');
        els.userLabel.textContent = '-';
        els.appCard.classList.add('hidden');
        els.loginCard.classList.remove('hidden');
        els.btnLogout.classList.add('hidden');
        setStatus('พร้อมเข้าสู่ระบบ', 'warn');
      }

      function createClientFromInputs() {
        var scriptUrl = C.normalizeScriptUrl(els.scriptUrl.value || '');
        var deviceKey = C.safeTrim(els.deviceKey.value || '');

        if (!scriptUrl) throw new Error('กรุณาตั้งค่า Apps Script URL');
        if (!deviceKey) throw new Error('กรุณาระบุ Device Key');

        state.settings = C.persistSettings(scriptUrl, deviceKey);
        state.api = C.createApiClient(state.settings);

        return state.api;
      }

      function buildDocLink(doc) {
        var docId = C.safeTrim((doc && (doc.docId || doc.amDocNoAk || doc.receiveNo)) || '');
        if (!docId) return '#';
        return C.buildPageUrl('document-view.html', { id: docId });
      }

      function renderStats(stats) {
        var s = (stats && typeof stats === 'object') ? stats : {};
        var cards = [
          { key: 'total', label: 'ทั้งหมด', cls: 's-total' },
          { key: 'stored', label: 'จัดเก็บแล้ว', cls: 's-stored' },
          { key: 'completed', label: 'เสร็จสิ้น', cls: 's-completed' },
          { key: 'pending', label: 'รอจัดเก็บ', cls: 's-pending' },
          { key: 'inprogress', label: 'กำลังดำเนินการ', cls: 's-inprogress' },
          { key: 'assigned', label: 'มอบผู้รับผิดชอบ', cls: 's-assigned' },
          { key: 'returned', label: 'ส่งคืนฯ', cls: 's-return' },
          { key: 'cancelled', label: 'ยกเลิก', cls: 's-cancel' }
        ];

        var html = '';
        for (var i = 0; i < cards.length; i++) {
          var card = cards[i];
          var value = Number(s[card.key] || 0);
          html += '<div class="stat-card ' + card.cls + '">';
          html += '<div class="stat-label">' + C.escapeHtml(card.label) + '</div>';
          html += '<div class="stat-num">' + value + '</div>';
          html += '</div>';
        }

        els.statsRow.innerHTML = html;
      }

      function getDocStatusClass(status, storedLoc) {
        var st = C.safeTrim(status || '');
        var hasStoredLoc = !!C.safeTrim(storedLoc || '');
        if (st === 'ยกเลิก') return 'status-cancelled';
        if (st === 'อนุมัติแล้วส่งคืนเจ้าของเรื่อง') return 'status-returned';
        if (hasStoredLoc) return 'status-stored';
        if (st === 'กำลังดำเนินการ') return 'status-inprogress';
        if (st === 'มอบผู้รับผิดชอบ') return 'status-assigned';
        return 'status-completed';
      }

      function getStatusBadge(status) {
        var st = C.safeTrim(status || '');
        if (st === 'ยกเลิก') return '<span class="status-badge badge err">ยกเลิก</span>';
        if (st === 'อนุมัติแล้วส่งคืนเจ้าของเรื่อง') return '<span class="status-badge">ส่งคืนฯ</span>';
        if (st === 'กำลังดำเนินการ') return '<span class="status-badge badge info">กำลังดำเนินการ</span>';
        if (st === 'มอบผู้รับผิดชอบ') return '<span class="status-badge" style="border-color:rgba(236,72,153,.52);background:rgba(251,207,232,.8);color:#9d174d">มอบผู้รับผิดชอบ</span>';
        return '<span class="status-badge badge ok">ดำเนินการเสร็จ</span>';
      }

      function getStoredUserChip(d) {
        var storedUser = C.safeTrim(d && d.storedUser || '');
        if (!storedUser) return '';
        var img = C.safeTrim(d && d.storedUserImg || '');
        var avatar = img
          ? '<img alt="u" src="' + C.escapeHtml(img) + '" width="22" height="22" style="border-radius:50%;object-fit:cover;border:1.4px solid rgba(10,132,255,.26)">'
          : '<span style="width:22px;height:22px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:rgba(10,132,255,.16);border:1px solid rgba(10,132,255,.25);font-size:.62rem;font-weight:900;color:#0c4a6e">' + C.escapeHtml((storedUser.charAt(0) || '?').toUpperCase()) + '</span>';
        return '<span class="status-badge" style="display:inline-flex;align-items:center;gap:6px;padding:3px 8px;max-width:210px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + avatar + '<span>' + C.escapeHtml(storedUser) + '</span></span>';
      }

      function renderDocs(result) {
        var docs = (result && Array.isArray(result.docs)) ? result.docs : [];
        var pagination = result && result.pagination ? result.pagination : {};
        var stats = result && result.stats ? result.stats : {};

        state.totalPages = Number(pagination.totalPages || 1);
        state.totalItems = Number(pagination.totalItems || docs.length || 0);
        renderStats(stats);

        els.pageInfo.textContent = 'หน้า ' + state.page + ' / ' + state.totalPages + ' (' + state.totalItems + ' รายการ)';

        if (!docs.length) {
          els.docsList.innerHTML = '<div class="empty">ไม่พบเอกสาร</div>';
          return;
        }

        var html = '';
        for (var i = 0; i < docs.length; i++) {
          var d = docs[i] || {};
          var status = C.safeText(d.docStatus || '-');
          var storedLocRaw = C.safeTrim(d.storedLoc || '');
          var storedLoc = storedLocRaw || '-';
          var statusClass = getDocStatusClass(status, storedLocRaw);
          var subject = C.safeText(d.subject || '-');
          if (subject.length > 180) subject = subject.substring(0, 180).replace(/\s+$/, '') + '...';
          var docNo = C.safeText(d.amDocNoAk || d.amDocNo || d.receiveNo || d.docNoSdh || '-');
          var docNoSdh = C.safeTrim(d.docNoSdh || '');
          var receiveNo = C.safeText(d.receiveNo || '-');
          var dateRec = C.safeText(d.dateRec || '-');
          var rowNo = (state.page - 1) * state.itemsPerPage + (i + 1);
          var sender = C.safeText(d.sender || '-');
          var group = C.safeText(d.group || '-');
          var budgetType = C.safeTrim(d.budgetType || '') || 'ไม่ระบุงบฯ';
          var link = buildDocLink(d);
          var storedUserChip = getStoredUserChip(d);

          html += '<a class="doc-list-card doc-card ' + statusClass + '" href="' + C.escapeHtml(link) + '">';
          html += '<div class="doc-top">';
          html += '<div style="min-width:0">';
          html += '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
          html += '<span class="status-badge" style="font-weight:900;background:rgba(10,132,255,.1);border-color:rgba(10,132,255,.26);color:#0a84ff">#' + rowNo + '</span>';
          html += '<span class="doc-title">' + C.escapeHtml(docNo) + '</span>';
          html += '</div>';
          if (docNoSdh && docNoSdh !== docNo) html += '<div class="doc-subtitle">สธ ' + C.escapeHtml(docNoSdh) + '</div>';
          html += '</div>';
          html += '<div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">';
          html += '<span class="status-badge" style="border-color:rgba(2,132,199,.46);background:rgba(125,211,252,.28);color:#0c4a6e">' + C.escapeHtml(budgetType) + '</span>';
          html += getStatusBadge(status);
          if (storedLocRaw) {
            html += '<span class="status-badge stored"><i class="bi bi-archive-fill"></i> ' + C.escapeHtml(storedLoc) + '</span>';
          } else {
            html += '<span class="status-badge warn">รอจัดเก็บ</span>';
          }
          html += '</div>';
          html += '</div>';
          html += '<p class="doc-subject">' + C.escapeHtml(subject) + '</p>';
          html += '<div class="doc-foot">';
          html += '<small>' + C.escapeHtml((group + ' ' + sender).replace(/\\s+/g, ' ').trim()) + '</small>';
          html += '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
          html += '<small>รับ: ' + C.escapeHtml(receiveNo) + '</small>';
          html += '<small>วันที่รับ: ' + C.escapeHtml(dateRec) + '</small>';
          html += storedUserChip;
          html += '</div>';
          html += '</div>';
          html += '</a>';
        }

        els.docsList.innerHTML = html;
      }

      function aggregateBoxes(reportDocs, storageOptions) {
        var docs = Array.isArray(reportDocs) ? reportDocs : [];
        var optionData = storageOptions && storageOptions.data ? storageOptions.data : {};
        var knownBoxes = Array.isArray(optionData.allBoxes) ? optionData.allBoxes : [];

        var map = {};
        var i;

        for (i = 0; i < knownBoxes.length; i++) {
          var boxName = C.safeTrim(knownBoxes[i] || '');
          if (!boxName) continue;
          map[boxName] = 0;
        }

        for (i = 0; i < docs.length; i++) {
          var d = docs[i] || {};
          var storedLoc = C.safeTrim(d.storedLoc || '');
          if (!storedLoc) continue;
          if (!Object.prototype.hasOwnProperty.call(map, storedLoc)) map[storedLoc] = 0;
          map[storedLoc] += 1;
        }

        var out = [];
        for (var key in map) {
          if (!Object.prototype.hasOwnProperty.call(map, key)) continue;
          out.push({ name: key, count: Number(map[key] || 0) });
        }

        out.sort(function (a, b) {
          if (b.count !== a.count) return b.count - a.count;
          return String(a.name).localeCompare(String(b.name), 'th');
        });

        return out;
      }

      function renderBoxes() {
        if (!state.boxSummary.length) {
          els.boxSummaryLabel.textContent = 'ไม่พบข้อมูลกล่อง';
          els.boxesWrap.innerHTML = '<div class="empty" style="grid-column:1 / -1;">ยังไม่มีกล่องที่บันทึกข้อมูล</div>';
          return;
        }

        var html = '';
        var totalDocs = 0;

        for (var i = 0; i < state.boxSummary.length; i++) {
          var box = state.boxSummary[i] || {};
          totalDocs += Number(box.count || 0);
          var url = C.buildPageUrl('storage-box-view.html', { box: box.name });
          html += '<a class="box-card" href="' + C.escapeHtml(url) + '">';
          html += '<div class="box-name">' + C.escapeHtml(box.name || '-') + '</div>';
          html += '<div class="box-count">' + Number(box.count || 0) + ' รายการ</div>';
          html += '</a>';
        }

        els.boxSummaryLabel.textContent = 'รวม ' + state.boxSummary.length + ' กล่อง | เอกสารที่จัดเก็บแล้ว ' + totalDocs + ' รายการ';
        els.boxesWrap.innerHTML = html;
      }

      function loadDocs(resetPage) {
        if (!state.api) return Promise.reject(new Error('ยังไม่ได้ตั้งค่า API'));
        if (!state.user) return Promise.reject(new Error('กรุณาเข้าสู่ระบบ'));

        if (resetPage) state.page = 1;
        state.itemsPerPage = Number(els.itemsPerPage.value || 20) || 20;
        state.searchQuery = C.safeText(els.searchQuery.value).trim();
        state.statusFilter = C.safeText(els.statusFilter.value || 'all').trim() || 'all';

        setLoading(true);
        showError('');

        return state.api.docsList({
          page: state.page,
          itemsPerPage: state.itemsPerPage,
          searchQuery: state.searchQuery,
          statusFilter: state.statusFilter
        }).then(function (res) {
          renderDocs(res || {});
          setLoading(false);
        }).catch(function (err) {
          setLoading(false);
          throw err;
        });
      }

      function loadBoxes() {
        if (!state.api || !state.user) return Promise.resolve();

        setLoading(true);
        return Promise.all([
          state.api.systemReport(),
          state.api.storageOptions()
        ]).then(function (results) {
          var report = results[0] || {};
          var storage = results[1] || {};
          var docs = Array.isArray(report.docs) ? report.docs : [];

          state.lastSystemReport = report;
          state.boxSummary = aggregateBoxes(docs, storage);
          renderBoxes();
          setLoading(false);
        }).catch(function (err) {
          setLoading(false);
          showError((err && err.message) ? err.message : 'โหลดข้อมูลกล่องไม่สำเร็จ');
        });
      }

      function trySession() {
        if (!state.api) return Promise.resolve(false);
        setStatus('กำลังตรวจสอบ session...', 'warn');

        return state.api.me().then(function (res) {
          if (res && res.success && res.user) {
            setLoggedIn(res.user);
            return loadDocs(true)
              .then(function () { return loadBoxes(); })
              .then(function () { return true; })
              .catch(function (err) {
                showError((err && err.message) ? err.message : 'โหลดข้อมูลหลังเข้าสู่ระบบไม่สำเร็จ');
                return true;
              });
          }
          setLoggedIn(null);
          return false;
        }).catch(function () {
          setLoggedIn(null);
          return false;
        });
      }

      function saveSettings() {
        showError('');
        try {
          createClientFromInputs();
          els.settingsCard.classList.add('hidden');
          setStatus('ตั้งค่าแล้ว', 'warn');
          return trySession();
        } catch (err) {
          showError(err && err.message ? err.message : String(err));
          return Promise.resolve(false);
        }
      }

      function login() {
        if (!state.api) {
          showError('กรุณาตั้งค่า API ก่อนเข้าสู่ระบบ');
          return;
        }

        var username = C.safeText(els.username.value).trim();
        var password = C.safeText(els.password.value);
        if (!username || !password) {
          showError('กรุณากรอก Username และ Password');
          return;
        }

        setLoading(true);
        showError('');
        setStatus('กำลังเข้าสู่ระบบ...', 'warn');

        state.api.login(username, password).then(function (res) {
          if (!res || res.success === false) {
            throw new Error(res && res.error ? res.error : 'เข้าสู่ระบบไม่สำเร็จ');
          }

          setLoggedIn(res.user || { username: username });
          return loadDocs(true)
            .catch(function (err) {
              showError((err && err.message) ? err.message : 'ไม่สามารถโหลดรายการเอกสารได้');
            })
            .then(function () { return loadBoxes(); })
            .finally(function () { setLoading(false); });
        }).catch(function (err) {
          setLoading(false);
          setLoggedIn(null);
          showError(err && err.message ? err.message : 'เข้าสู่ระบบไม่สำเร็จ');
          setStatus('เข้าสู่ระบบไม่สำเร็จ', 'error');
        });
      }

      function logout() {
        if (!state.api) {
          setLoggedIn(null);
          return;
        }

        setLoading(true);

        state.api.logout().finally(function () {
          setLoading(false);
          setLoggedIn(null);
          state.boxSummary = [];
          state.lastSystemReport = null;

          els.docsList.innerHTML = '<div class="empty">ยังไม่มีข้อมูล</div>';
          renderStats({});
          els.pageInfo.textContent = 'หน้า 1 / 1 (0 รายการ)';
          els.boxesWrap.innerHTML = '<div class="empty" style="grid-column:1 / -1;">ยังไม่มีกล่องที่บันทึกข้อมูล</div>';
          els.boxSummaryLabel.textContent = 'ไม่พบข้อมูลกล่อง';
        });
      }

      function printAllReport() {
        if (!state.api) return;

        var ensureReport = state.lastSystemReport && Array.isArray(state.lastSystemReport.docs)
          ? Promise.resolve(state.lastSystemReport)
          : state.api.systemReport();

        ensureReport.then(function (res) {
          var report = res || {};
          var docs = Array.isArray(report.docs) ? report.docs : [];
          if (!docs.length) {
            showError('ไม่พบข้อมูลรายงานสำหรับพิมพ์');
            return;
          }

          state.lastSystemReport = report;

          var w = window.open('', '', 'width=1220,height=820');
          if (!w) {
            showError('ไม่สามารถเปิดหน้าต่างพิมพ์ (Pop-up ถูกบล็อก)');
            return;
          }

          var esc = C.escapeHtml;
          var h = '';
          h += '<!doctype html><html><head><meta charset="utf-8"><title>รายงานเอกสารทั้งหมด</title>';
          h += '<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">';
          h += '<style>@page{size:A4 landscape;margin:8mm}body{font-family:"IBM Plex Sans Thai",sans-serif;margin:0;padding:8px;color:#0f172a}h2{margin:0 0 2px;text-align:center;font-size:21px;font-weight:800}p.sub{margin:0 0 6px;text-align:center;font-size:12px;color:#334155}p.meta{margin:0 0 8px;text-align:center;font-size:11px;color:#475569}table{width:100%;border-collapse:collapse;table-layout:fixed}th,td{border:1px solid #334155;padding:4px 5px;font-size:10.2px;line-height:1.28;vertical-align:top}th{background:#e2e8f0;text-align:center;font-weight:800}.text-center{text-align:center}.text-right{text-align:right}.subject,.sender,.budget,.status,.loc{white-space:normal;overflow-wrap:anywhere;word-break:break-word}.nowrap{white-space:nowrap}</style>';
          h += '</head><body>';
          h += '<h2>รายงานรายการเอกสารทั้งหมดในระบบ</h2>';
          h += '<p class="sub">จำนวนทั้งหมด ' + docs.length + ' รายการ</p>';
          h += '<p class="meta">พิมพ์เมื่อ: ' + esc(new Date().toLocaleString('th-TH')) + '</p>';
          h += '<table><thead><tr><th style="width:4%">ลำดับ</th><th style="width:6%">ปีงบฯ</th><th style="width:11%">เลขที่หนังสือส่งกองคลัง</th><th style="width:9%">เลขที่ สธ.</th><th style="width:20%">ชื่อเรื่อง</th><th style="width:11%">ประเภทเงินงบประมาณ</th><th style="width:8%">จำนวน</th><th style="width:9%">สถานะ</th><th style="width:9%">สถานที่เก็บ</th><th style="width:8%">วันที่รับ</th><th style="width:10%">ผู้ส่ง</th></tr></thead><tbody>';

          for (var i = 0; i < docs.length; i++) {
            var d = docs[i] || {};
            var recNo = C.safeText(d.receiveNo || '');
            var fiscal = recNo && recNo.indexOf('/') > -1 ? recNo.split('/')[0] : '';
            var subject = C.safeText(d.subject || '-');
            if (subject.length > 220) subject = subject.substring(0, 220).replace(/\s+$/, '') + '...';

            h += '<tr>';
            h += '<td class="text-center nowrap">' + (i + 1) + '</td>';
            h += '<td class="text-center nowrap">' + esc(fiscal) + '</td>';
            h += '<td class="text-center nowrap">' + esc(d.amDocNoAk || d.amDocNo || '') + '</td>';
            h += '<td class="text-center nowrap">' + esc(d.docNoSdh || '') + '</td>';
            h += '<td class="subject">' + esc(subject) + '</td>';
            h += '<td class="budget">' + esc(d.budgetType || '-') + '</td>';
            h += '<td class="text-right nowrap">' + esc(d.amount || '-') + '</td>';
            h += '<td class="status text-center">' + esc(d.docStatus || '-') + '</td>';
            h += '<td class="loc text-center">' + esc(d.storedLoc || '-') + '</td>';
            h += '<td class="text-center nowrap">' + esc(d.dateRec || '') + '</td>';
            h += '<td class="sender">' + esc(d.sender || '') + '</td>';
            h += '</tr>';
          }

          h += '</tbody></table>';
          h += '<script>window.onload=function(){window.print();window.close();}<' + '/script>';
          h += '</body></html>';

          w.document.write(h);
          w.document.close();
        }).catch(function (err) {
          showError((err && err.message) ? err.message : 'ไม่สามารถดึงข้อมูลรายงานได้');
        });
      }

      function init() {
        document.body.classList.add('login-mode');
        state.config = C.readConfig();
        applyConfigToUI(state.config);
        applyLockMode(state.config);

        var current = C.getStoredSettings();
        var initialUrl = C.safeText(current.scriptUrl || '');
        var initialDeviceKey = C.safeText(current.deviceKey || C.randomDeviceKey());

        els.scriptUrl.value = initialUrl;
        els.deviceKey.value = initialDeviceKey;

        els.btnOpenSettings.addEventListener('click', function () {
          els.settingsCard.classList.toggle('hidden');
        });

        els.btnGenerateDevice.addEventListener('click', function () {
          els.deviceKey.value = C.randomDeviceKey();
        });

        els.btnSaveSettings.addEventListener('click', function () {
          saveSettings();
        });

        els.btnLogin.addEventListener('click', function () {
          login();
        });

        if (els.btnTogglePassword) {
          els.btnTogglePassword.addEventListener('click', function () {
            var isHidden = els.password.type === 'password';
            els.password.type = isHidden ? 'text' : 'password';
            if (els.passwordEyeIcon) {
              els.passwordEyeIcon.className = isHidden ? 'bi bi-eye-slash' : 'bi bi-eye';
            }
          });
        }

        els.password.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') login();
        });

        els.btnLogout.addEventListener('click', function () {
          logout();
        });

        els.tabDocs.addEventListener('click', function () { switchTab('docs'); });
        els.tabBoxes.addEventListener('click', function () { switchTab('boxes'); });

        els.btnAdd.addEventListener('click', function () {
          C.redirect('document-form.html', { mode: 'add' });
        });

        els.btnBoxScan.addEventListener('click', function () {
          C.redirect('storage-box-scan.html');
        });

        els.btnInspection.addEventListener('click', function () {
          C.redirect('inspection-report.html');
        });

        els.btnSearch.addEventListener('click', function () {
          loadDocs(true).catch(function (err) {
            showError(err && err.message ? err.message : 'ไม่สามารถโหลดข้อมูลเอกสารได้');
          });
        });

        els.searchQuery.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            loadDocs(true).catch(function (err) {
              showError(err && err.message ? err.message : 'ไม่สามารถโหลดข้อมูลเอกสารได้');
            });
          }
        });

        els.btnRefresh.addEventListener('click', function () {
          Promise.all([loadDocs(false), loadBoxes()]).catch(function (err) {
            showError(err && err.message ? err.message : 'ไม่สามารถโหลดข้อมูลได้');
          });
        });

        els.itemsPerPage.addEventListener('change', function () {
          loadDocs(true).catch(function (err) {
            showError(err && err.message ? err.message : 'ไม่สามารถโหลดข้อมูลเอกสารได้');
          });
        });

        els.btnPrev.addEventListener('click', function () {
          if (state.page <= 1) return;
          state.page -= 1;
          loadDocs(false).catch(function (err) {
            state.page += 1;
            showError(err && err.message ? err.message : 'ไม่สามารถโหลดข้อมูลเอกสารได้');
          });
        });

        els.btnNext.addEventListener('click', function () {
          if (state.page >= state.totalPages) return;
          state.page += 1;
          loadDocs(false).catch(function (err) {
            state.page -= 1;
            showError(err && err.message ? err.message : 'ไม่สามารถโหลดข้อมูลเอกสารได้');
          });
        });

        els.btnReloadBoxes.addEventListener('click', function () {
          loadBoxes();
        });

        els.btnPrintAll.addEventListener('click', function () {
          printAllReport();
        });

        switchTab('docs');
        renderStats({});

        if (initialUrl) {
          try {
            createClientFromInputs();
            trySession().then(function (ok) {
              if (!ok) {
                els.loginCard.classList.remove('hidden');
                setStatus('พร้อมเข้าสู่ระบบ', 'warn');
              }
            });
          } catch (err) {
            showError(err && err.message ? err.message : String(err));
            els.settingsCard.classList.remove('hidden');
            els.loginCard.classList.remove('hidden');
            setStatus('ตั้งค่า API ไม่ถูกต้อง', 'error');
          }
        } else {
          if (!state.config.lockSettings) {
            els.settingsCard.classList.remove('hidden');
          }

          els.loginCard.classList.remove('hidden');

          if (state.config.lockSettings) {
            setStatus('config.js ยังไม่ตั้งค่า URL', 'error');
            showError('กรุณาตั้งค่า scriptUrl ในไฟล์ config.js ก่อนใช้งาน');
          } else {
            setStatus('ยังไม่ได้ตั้งค่า API', 'warn');
          }
        }
      }

      init();
    })();
  </script>
</body>
</html>
