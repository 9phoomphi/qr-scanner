<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>สแกนเอกสารเข้ากล่อง</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    :root {
      --bg: #f3f6fb;
      --card: rgba(255,255,255,0.9);
      --text: #0f172a;
      --muted: #475569;
      --border: #dbe4f0;
      --primary: #2563eb;
      --primary2: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --shadow: 0 18px 46px rgba(15,23,42,0.14);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "IBM Plex Sans Thai", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 540px at 8% -14%, rgba(59,130,246,0.22), rgba(59,130,246,0)), var(--bg);
    }

    .shell { max-width: 1140px; margin: 0 auto; padding: 14px; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
      backdrop-filter: saturate(160%) blur(8px);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .title { margin: 0; font-size: 1.1rem; font-weight: 800; }
    .muted { color: var(--muted); }

    .grid {
      display: grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 12px;
      align-items: start;
    }

    .btn {
      border: none;
      border-radius: 999px;
      height: 42px;
      padding: 0 14px;
      color: #fff;
      font: inherit;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
    }

    .btn.secondary { background: #334155; }
    .btn.outline { background: #fff; color: var(--primary2); border: 1px solid #93c5fd; }
    .btn.success { background: linear-gradient(180deg, #22c55e, #16a34a); }
    .btn.danger { background: linear-gradient(180deg, #ef4444, #dc2626); }

    .error {
      border: 1px solid rgba(220,38,38,.35);
      background: rgba(220,38,38,.08);
      color: #991b1b;
      border-radius: 10px;
      padding: 10px;
      font-size: 0.9rem;
    }

    .hidden { display: none !important; }

    .camera-shell {
      position: relative;
      width: 100%;
      aspect-ratio: 1/1;
      min-height: 280px;
      border-radius: 16px;
      overflow: hidden;
      background: #020617;
      border: 1px solid rgba(148,163,184,.4);
    }

    #reader,
    #reader__scan_region {
      width: 100% !important;
      height: 100% !important;
    }

    #reader__dashboard,
    #reader__header_message {
      display: none !important;
    }

    #reader video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
    }

    .scan-guide {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: min(74%, 310px);
      height: min(74%, 310px);
      border: 2px solid rgba(125,211,252,.92);
      border-radius: 18px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.4), 0 0 0 999px rgba(2,6,23,.26);
      pointer-events: none;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: .82rem;
      font-weight: 800;
      border: 1px solid var(--border);
      color: #334155;
      background: #eef4ff;
    }

    .status.active {
      background: rgba(22,163,74,.14);
      border-color: rgba(22,163,74,.36);
      color: #166534;
    }

    .status.busy {
      background: rgba(37,99,235,.14);
      border-color: rgba(37,99,235,.36);
      color: #1d4ed8;
    }

    .status.error {
      background: rgba(220,38,38,.12);
      border-color: rgba(220,38,38,.34);
      color: #991b1b;
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    .queue-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .queue-list {
      max-height: 520px;
      overflow: auto;
      padding-right: 2px;
    }

    .queue-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 8px;
      background: #f8fbff;
    }

    .queue-item:last-child { margin-bottom: 0; }

    .queue-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      flex-wrap: wrap;
    }

    .queue-title {
      font-size: .9rem;
      font-weight: 800;
      color: #1d4ed8;
      word-break: break-all;
    }

    .queue-sub {
      font-size: .78rem;
      color: #475569;
      margin-top: 2px;
    }

    .queue-remove {
      border: 1px solid rgba(220,38,38,.34);
      background: rgba(220,38,38,.08);
      color: #b91c1c;
      border-radius: 999px;
      height: 30px;
      padding: 0 10px;
      font: inherit;
      font-weight: 700;
      cursor: pointer;
    }

    .empty {
      text-align: center;
      color: #64748b;
      font-weight: 600;
      padding: 14px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: #f8fbff;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 540px) {
      .queue-actions { grid-template-columns: 1fr; }
      .camera-shell { min-height: 220px; }
    }
  </style>
  <link rel="stylesheet" href="./theme-legacy.css">
</head>
<body>
  <div class="shell">
    <div class="card topbar">
      <div>
        <h1 class="title">สแกนเอกสารเข้ากล่องจัดเก็บ</h1>
        <div class="muted" style="font-size:0.84rem;">สแกน QR เอกสาร, เลือกปีงบประมาณและกล่อง, บันทึกเป็นรอบ</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="btnBack" class="btn secondary" type="button"><i class="bi bi-arrow-left"></i> กลับ</button>
        <button id="btnReload" class="btn outline" type="button"><i class="bi bi-arrow-clockwise"></i> โหลดใหม่</button>
      </div>
    </div>

    <div id="errBox" class="error hidden"></div>

    <div id="mainWrap" class="hidden">
      <div class="grid">
        <div class="card">
          <div class="camera-shell">
            <div id="reader"></div>
            <div class="scan-guide"></div>
          </div>

          <div style="display:flex;justify-content:center;margin-top:10px;">
            <span id="scanStatus" class="status"><i class="bi bi-camera"></i>พร้อมเริ่มสแกน</span>
          </div>
          <div id="scanMessage" class="muted" style="text-align:center;font-size:.82rem;margin-top:6px;min-height:18px;"></div>

          <div class="actions">
            <button id="btnStart" class="btn success" type="button"><i class="bi bi-camera-video"></i> เริ่มสแกน</button>
            <button id="btnStop" class="btn danger hidden" type="button"><i class="bi bi-stop-circle"></i> หยุดสแกน</button>
          </div>
        </div>

        <div class="card">
          <div class="topbar" style="margin-bottom:8px;">
            <div class="title" style="font-size:1rem;">รายการรอบบันทึก (<span id="queueCount">0</span>)</div>
          </div>

          <div class="queue-actions">
            <button id="btnSaveQueue" class="btn" type="button"><i class="bi bi-save"></i> บันทึกรายการ</button>
            <button id="btnClearQueue" class="btn outline" type="button"><i class="bi bi-trash"></i> ล้างรายการ</button>
          </div>

          <div id="queueList" class="queue-list">
            <div class="empty">ยังไม่มีรายการที่รอบันทึก</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script src="./api-client.js"></script>
  <script src="./theme-legacy.js"></script>
  <script src="./app-common.js"></script>
  <script>
    (function () {
      'use strict';

      var C = window.DocFrontendCommon;

      var state = {
        settings: null,
        api: null,
        user: null,
        storageMaster: { fiscalYears: [], boxesByFiscalYear: {}, allBoxes: [] },
        queue: [],
        html5Qr: null,
        isScanning: false,
        busy: false,
        saving: false,
        lastScanValue: '',
        lastScanAt: 0
      };

      var els = {
        btnBack: document.getElementById('btnBack'),
        btnReload: document.getElementById('btnReload'),
        errBox: document.getElementById('errBox'),
        mainWrap: document.getElementById('mainWrap'),
        scanStatus: document.getElementById('scanStatus'),
        scanMessage: document.getElementById('scanMessage'),
        btnStart: document.getElementById('btnStart'),
        btnStop: document.getElementById('btnStop'),
        queueCount: document.getElementById('queueCount'),
        queueList: document.getElementById('queueList'),
        btnSaveQueue: document.getElementById('btnSaveQueue'),
        btnClearQueue: document.getElementById('btnClearQueue')
      };

      function showError(message) {
        var msg = C.safeTrim(message || '');
        if (!msg) {
          els.errBox.classList.add('hidden');
          els.errBox.textContent = '';
          return;
        }
        els.errBox.textContent = msg;
        els.errBox.classList.remove('hidden');
      }

      function setStatus(message, mode) {
        var cls = 'status';
        if (mode === 'active') cls += ' active';
        else if (mode === 'busy') cls += ' busy';
        else if (mode === 'error') cls += ' error';

        var icon = 'bi-camera';
        if (mode === 'active') icon = 'bi-record-circle';
        else if (mode === 'busy') icon = 'bi-arrow-repeat';
        else if (mode === 'error') icon = 'bi-exclamation-triangle';

        els.scanStatus.className = cls;
        els.scanStatus.innerHTML = '<i class="bi ' + icon + '"></i>' + C.escapeHtml(message || '');
      }

      function setMessage(message) {
        els.scanMessage.textContent = C.safeText(message || '');
      }

      function normalizeDocId(raw) {
        var text = C.safeTrim(raw || '');
        if (!text) return '';

        try {
          var parsed = new URL(text, window.location.href);
          var idFromUrl = parsed.searchParams.get('id') || parsed.searchParams.get('ID');
          if (idFromUrl) text = decodeURIComponent(String(idFromUrl || ''));
        } catch (_e) {
          var m = text.match(/[?&]id=([^&#]+)/i);
          if (m && m[1]) {
            try { text = decodeURIComponent(m[1]); } catch (_e2) { text = m[1]; }
          }
        }

        text = C.safeTrim(text || '');
        while (text && text.charAt(0) === '\'') text = text.substring(1);
        return text;
      }

      function getFiscalYears() {
        var years = (state.storageMaster && Array.isArray(state.storageMaster.fiscalYears)) ? state.storageMaster.fiscalYears : [];
        var out = [];
        for (var i = 0; i < years.length; i++) {
          var y = C.safeTrim(years[i] || '');
          var yk = y.toLowerCase();
          if (!y || yk === 'all' || yk === '__all__' || yk === 'ทั้งหมด') continue;
          out.push(y);
        }
        return out;
      }

      function getBoxesForFiscal(fiscalYear) {
        var fy = C.safeTrim(fiscalYear || '');
        var map = (state.storageMaster && state.storageMaster.boxesByFiscalYear && typeof state.storageMaster.boxesByFiscalYear === 'object')
          ? state.storageMaster.boxesByFiscalYear
          : {};
        var allBoxes = Array.isArray(state.storageMaster.allBoxes) ? state.storageMaster.allBoxes : [];

        if (fy && Array.isArray(map[fy]) && map[fy].length) return map[fy];
        if (Array.isArray(map.__all__) && map.__all__.length) return map.__all__;
        return allBoxes;
      }

      function queueHasDoc(docId) {
        var id = normalizeDocId(docId);
        if (!id) return false;
        for (var i = 0; i < state.queue.length; i++) {
          if (normalizeDocId(state.queue[i].docId) === id) return true;
        }
        return false;
      }

      function renderQueue() {
        els.queueCount.textContent = String(state.queue.length);

        if (!state.queue.length) {
          els.queueList.innerHTML = '<div class="empty">ยังไม่มีรายการที่รอบันทึก</div>';
          refreshButtons();
          return;
        }

        var html = '';
        for (var i = 0; i < state.queue.length; i++) {
          var item = state.queue[i] || {};
          html += '<div class="queue-item">';
          html += '<div class="queue-top">';
          html += '<div>';
          html += '<div class="queue-title">ID: ' + C.escapeHtml(item.docId || '-') + '</div>';
          html += '<div class="queue-sub">ปีงบฯ: ' + C.escapeHtml(item.fiscalYear || '-') + ' | กล่อง: ' + C.escapeHtml(item.boxId || '-') + ' | เวลา: ' + C.escapeHtml(item.timeText || '-');
          if (C.safeTrim(item.error || '')) html += ' | ผิดพลาด: ' + C.escapeHtml(item.error);
          html += '</div>';
          html += '</div>';
          html += '<button class="queue-remove" type="button" data-remove-index="' + i + '"><i class="bi bi-x-lg"></i> ลบ</button>';
          html += '</div>';
          html += '</div>';
        }

        els.queueList.innerHTML = html;

        var removeButtons = els.queueList.querySelectorAll('[data-remove-index]');
        for (var r = 0; r < removeButtons.length; r++) {
          removeButtons[r].addEventListener('click', function () {
            var idx = Number(this.getAttribute('data-remove-index') || '-1');
            if (isNaN(idx) || idx < 0 || idx >= state.queue.length) return;
            state.queue.splice(idx, 1);
            renderQueue();
          });
        }

        refreshButtons();
      }

      function refreshButtons() {
        els.btnStart.classList.toggle('hidden', state.isScanning);
        els.btnStop.classList.toggle('hidden', !state.isScanning);

        els.btnStart.disabled = state.busy || state.saving || state.isScanning;
        els.btnStop.disabled = state.busy || state.saving || !state.isScanning;
        els.btnSaveQueue.disabled = state.busy || state.saving || !state.queue.length;
        els.btnClearQueue.disabled = state.busy || state.saving || !state.queue.length;
      }

      function playHitFeedback() {
        if (navigator.vibrate) {
          try { navigator.vibrate(80); } catch (_e) {}
        }
      }

      async function askStoragePlacement(docId) {
        var years = getFiscalYears();
        if (!years.length) {
          throw new Error('ไม่พบข้อมูลปีงบประมาณสำหรับการจัดเก็บ');
        }

        var result = await Swal.fire({
          title: 'เลือกปีงบประมาณและกล่อง',
          html: ''
            + '<div style="text-align:left;">'
            + '<label style="font-size:.82rem;font-weight:700;color:#475569;">ปีงบประมาณ</label>'
            + '<select id="swFiscal" style="width:100%;min-height:42px;border-radius:10px;margin:6px 0 10px;border:1px solid #cbd5e1;padding:6px 8px;"></select>'
            + '<label style="font-size:.82rem;font-weight:700;color:#475569;">กล่องเอกสาร</label>'
            + '<select id="swBox" style="width:100%;min-height:42px;border-radius:10px;margin-top:6px;border:1px solid #cbd5e1;padding:6px 8px;"></select>'
            + '</div>',
          showCancelButton: true,
          confirmButtonText: 'เพิ่มเข้ารายการ',
          cancelButtonText: 'ยกเลิก',
          didOpen: function () {
            var fyEl = document.getElementById('swFiscal');
            var boxEl = document.getElementById('swBox');
            if (!fyEl || !boxEl) return;

            fyEl.innerHTML = '';
            for (var i = 0; i < years.length; i++) {
              fyEl.innerHTML += '<option value="' + C.escapeHtml(years[i]) + '">' + C.escapeHtml(years[i]) + '</option>';
            }

            function fillBoxes() {
              var fy = C.safeTrim(fyEl.value || '');
              var boxes = getBoxesForFiscal(fy);
              boxEl.innerHTML = '';
              for (var b = 0; b < boxes.length; b++) {
                boxEl.innerHTML += '<option value="' + C.escapeHtml(boxes[b]) + '">' + C.escapeHtml(boxes[b]) + '</option>';
              }
              if (!boxes.length) {
                boxEl.innerHTML = '<option value="">ไม่พบกล่องเอกสาร</option>';
              }
            }

            fyEl.addEventListener('change', fillBoxes);
            fillBoxes();
          },
          preConfirm: function () {
            var fiscalYear = C.safeTrim((document.getElementById('swFiscal') || {}).value || '');
            var boxId = C.safeTrim((document.getElementById('swBox') || {}).value || '');
            if (!fiscalYear) {
              Swal.showValidationMessage('กรุณาเลือกปีงบประมาณ');
              return false;
            }
            if (!boxId) {
              Swal.showValidationMessage('กรุณาเลือกกล่องเอกสาร');
              return false;
            }
            return {
              docId: docId,
              fiscalYear: fiscalYear,
              boxId: boxId,
              timeText: new Date().toLocaleTimeString('th-TH')
            };
          }
        });

        if (!result || !result.isConfirmed || !result.value) return null;
        return result.value;
      }

      async function handleScanResult(decodedText) {
        if (state.busy || state.saving) return;

        var now = Date.now();
        var docId = normalizeDocId(decodedText);
        if (!docId) return;

        if (docId === state.lastScanValue && (now - state.lastScanAt) < 2500) return;
        if ((now - state.lastScanAt) < 600) return;

        state.lastScanValue = docId;
        state.lastScanAt = now;

        if (queueHasDoc(docId)) {
          setMessage('รายการนี้อยู่ในคิวแล้ว');
          Swal.fire('มีรายการนี้แล้ว', 'เอกสารนี้อยู่ในรายการรอบบันทึกแล้ว', 'info');
          return;
        }

        state.busy = true;
        refreshButtons();
        setStatus('กำลังตรวจสอบเอกสาร...', 'busy');
        setMessage('กำลังตรวจสอบสิทธิ์การจัดเก็บ');

        try {
          var eligibility = await state.api.checkStorageEligibility(docId);
          if (!eligibility || eligibility.success === false) {
            throw new Error((eligibility && eligibility.error) ? eligibility.error : 'เอกสารนี้ไม่สามารถจัดเก็บได้');
          }

          playHitFeedback();
          var item = await askStoragePlacement(eligibility.docId || docId);
          if (item) {
            state.queue.push(item);
            renderQueue();
            setMessage('เพิ่มเอกสารเข้ารายการแล้ว: ' + item.docId);
            Swal.fire({
              toast: true,
              position: 'top',
              icon: 'success',
              title: 'เพิ่มเข้ารายการแล้ว',
              showConfirmButton: false,
              timer: 1000,
              timerProgressBar: true
            });
          }

          setStatus(state.isScanning ? 'กำลังสแกน...' : 'พร้อมเริ่มสแกน', state.isScanning ? 'active' : '');
        } catch (err) {
          setStatus('เอกสารไม่ผ่านเงื่อนไข', 'error');
          setMessage((err && err.message) ? err.message : 'เกิดข้อผิดพลาด');
          Swal.fire('ไม่สามารถจัดเก็บ', (err && err.message) ? err.message : 'เอกสารนี้ไม่สามารถจัดเก็บได้', 'warning');
          if (state.isScanning) setStatus('กำลังสแกน...', 'active');
        } finally {
          state.busy = false;
          refreshButtons();
        }
      }

      function onScanFailure(_err) {}

      function isInIframeContext() {
        try {
          return window.self !== window.top;
        } catch (_e) {
          return true;
        }
      }

      function ensureCameraPrerequisites() {
        if (!window.isSecureContext) {
          throw new Error('insecure_context: ต้องเปิดผ่าน HTTPS เท่านั้น');
        }
        if (!navigator.mediaDevices || typeof navigator.mediaDevices.getUserMedia !== 'function') {
          throw new Error('media_devices_unavailable: เบราว์เซอร์นี้ไม่รองรับการเปิดกล้อง');
        }
      }

      async function requestCameraPermissionWarmup() {
        // ขอสิทธิ์กล้องล่วงหน้าแบบเดียวกับตัวอย่างที่ใช้ getUserMedia ตรงๆ
        var attempts = [
          { video: { facingMode: { ideal: 'environment' } }, audio: false },
          { video: { facingMode: 'environment' }, audio: false },
          { video: true, audio: false }
        ];
        var lastErr = null;
        for (var i = 0; i < attempts.length; i++) {
          try {
            var stream = await navigator.mediaDevices.getUserMedia(attempts[i]);
            if (stream && typeof stream.getTracks === 'function') {
              var tracks = stream.getTracks();
              for (var t = 0; t < tracks.length; t++) {
                try { tracks[t].stop(); } catch (_stopErr) {}
              }
            }
            return true;
          } catch (err) {
            lastErr = err;
          }
        }
        throw (lastErr || new Error('camera_permission_failed'));
      }

      function cameraLabelScore(label) {
        var text = C.safeTrim(label || '').toLowerCase();
        if (!text) return 0;
        var score = 0;
        if (text.indexOf('back') !== -1) score += 6;
        if (text.indexOf('rear') !== -1) score += 6;
        if (text.indexOf('environment') !== -1) score += 6;
        if (text.indexOf('หลัง') !== -1) score += 6;
        if (text.indexOf('หน้า') !== -1) score -= 4;
        if (text.indexOf('front') !== -1) score -= 4;
        if (text.indexOf('user') !== -1) score -= 4;
        return score;
      }

      async function detectPreferredCameraId() {
        if (typeof Html5Qrcode === 'undefined' || typeof Html5Qrcode.getCameras !== 'function') return '';
        try {
          var cameras = await Html5Qrcode.getCameras();
          if (!Array.isArray(cameras) || cameras.length === 0) return '';
          var best = cameras[0];
          var bestScore = cameraLabelScore(best && best.label);
          for (var i = 1; i < cameras.length; i++) {
            var score = cameraLabelScore(cameras[i] && cameras[i].label);
            if (score > bestScore) {
              best = cameras[i];
              bestScore = score;
            }
          }
          return C.safeTrim(best && best.id ? best.id : '');
        } catch (_e) {
          return '';
        }
      }

      async function startScannerWithFallback(config) {
        var targets = [];
        var preferredCameraId = await detectPreferredCameraId();
        if (preferredCameraId) {
          targets.push(preferredCameraId);
        }
        targets.push({ facingMode: { ideal: 'environment' } });
        targets.push({ facingMode: 'environment' });
        targets.push({ facingMode: 'user' });

        var lastErr = null;
        for (var i = 0; i < targets.length; i++) {
          try {
            await state.html5Qr.start(targets[i], config, handleScanResult, onScanFailure);
            return;
          } catch (err) {
            lastErr = err;
          }
        }
        throw (lastErr || new Error('ไม่สามารถเปิดกล้องได้'));
      }

      function cameraErrorMessage(err) {
        var raw = ((err && err.name) ? (err.name + ': ') : '') + ((err && err.message) ? err.message : 'ไม่สามารถเปิดกล้องได้');
        var lower = raw.toLowerCase();
        if (lower.indexOf('insecure_context') !== -1 || lower.indexOf('secure') !== -1 || lower.indexOf('https') !== -1) {
          return 'ต้องเปิดหน้านี้ด้วย HTTPS เท่านั้น (เช่นลิงก์ GitHub Pages แบบ https://...)';
        }
        if (lower.indexOf('media_devices_unavailable') !== -1 || lower.indexOf('getusermedia') !== -1 || lower.indexOf('undefined') !== -1) {
          return 'เบราว์เซอร์นี้ไม่รองรับการเปิดกล้อง (แนะนำ Chrome/Safari รุ่นล่าสุด)';
        }
        if (lower.indexOf('notallowederror') !== -1 || lower.indexOf('permission denied') !== -1 || lower.indexOf('denied') !== -1) {
          if (isInIframeContext()) {
            return 'เบราว์เซอร์บล็อกสิทธิ์กล้องในโหมด iframe ให้เปิดลิงก์หน้าเว็บโดยตรงในแท็บใหม่';
          }
          return 'เบราว์เซอร์ยังไม่ได้อนุญาตสิทธิ์กล้องสำหรับโดเมนนี้';
        }
        if (lower.indexOf('notfounderror') !== -1 || lower.indexOf('no camera') !== -1) {
          return 'ไม่พบกล้องบนอุปกรณ์นี้';
        }
        if (lower.indexOf('notreadableerror') !== -1 || lower.indexOf('could not start video source') !== -1) {
          return 'กล้องกำลังถูกใช้งานโดยแอปหรือแท็บอื่น';
        }
        return raw;
      }

      async function startScanner() {
        if (state.isScanning || state.busy || state.saving) return;
        if (typeof Html5Qrcode === 'undefined') {
          showError('ไม่พบไลบรารีกล้อง (Html5Qrcode)');
          return;
        }

        state.busy = true;
        refreshButtons();
        setStatus('กำลังเปิดกล้อง...', 'busy');
        setMessage('กำลังขอสิทธิ์กล้อง');

        try {
          ensureCameraPrerequisites();
          await requestCameraPermissionWarmup();
          if (!state.html5Qr) {
            state.html5Qr = new Html5Qrcode('reader');
          }

          var config = { fps: 10 };
          await startScannerWithFallback(config);

          state.isScanning = true;
          setStatus('กำลังสแกน...', 'active');
          setMessage('จัด QR ให้อยู่ในกรอบ');
        } catch (err) {
          state.isScanning = false;
          setStatus('ไม่สามารถเปิดกล้องได้', 'error');
          setMessage(cameraErrorMessage(err));
          Swal.fire('ไม่สามารถเปิดกล้องได้', cameraErrorMessage(err), 'error');
        } finally {
          state.busy = false;
          refreshButtons();
          if (!state.isScanning) setStatus('พร้อมเริ่มสแกน', '');
        }
      }

      async function stopScanner() {
        if (!state.html5Qr || !state.isScanning || state.busy || state.saving) {
          state.isScanning = false;
          refreshButtons();
          setStatus('พร้อมเริ่มสแกน', '');
          return;
        }

        state.busy = true;
        refreshButtons();
        setStatus('กำลังหยุดสแกน...', 'busy');

        try {
          await state.html5Qr.stop();
        } catch (_e) {}

        state.isScanning = false;
        state.busy = false;
        refreshButtons();
        setStatus('พร้อมเริ่มสแกน', '');
      }

      async function saveQueue() {
        if (!state.queue.length || state.busy || state.saving) return;

        state.saving = true;
        state.busy = true;
        refreshButtons();
        setStatus('กำลังบันทึกข้อมูล...', 'busy');
        setMessage('กำลังบันทึกรายการ ' + state.queue.length + ' รายการ');

        try {
          var payload = [];
          for (var i = 0; i < state.queue.length; i++) {
            payload.push({
              docId: state.queue[i].docId,
              boxId: state.queue[i].boxId,
              fiscalYear: state.queue[i].fiscalYear
            });
          }

          var userName = C.safeTrim((state.user && (state.user.displayName || state.user.username)) || '');
          var res = await state.api.saveDocumentsToBox(payload, '', userName);

          if (!res || res.success === false) {
            throw new Error((res && res.error) ? res.error : 'ไม่สามารถบันทึกข้อมูลได้');
          }

          var results = Array.isArray(res.results) ? res.results : [];
          var map = {};
          for (var r = 0; r < results.length; r++) {
            var key = normalizeDocId(results[r].docId || '');
            if (key) map[key] = results[r];
          }

          var nextQueue = [];
          var okCount = 0;

          for (var q = 0; q < state.queue.length; q++) {
            var item = state.queue[q];
            var row = map[normalizeDocId(item.docId || '')];
            if (row && row.success) {
              okCount++;
            } else {
              item.error = (row && row.error) ? row.error : 'บันทึกไม่สำเร็จ';
              nextQueue.push(item);
            }
          }

          state.queue = nextQueue;
          renderQueue();

          if (!state.queue.length) {
            setMessage('บันทึกสำเร็จทั้งหมด ' + okCount + ' รายการ');
            Swal.fire('บันทึกสำเร็จ', 'บันทึกเอกสาร ' + okCount + ' รายการเรียบร้อย', 'success');
          } else {
            var firstErr = C.safeTrim((state.queue[0] && state.queue[0].error) || '');
            var detail = 'สำเร็จ ' + okCount + ' รายการ / ไม่สำเร็จ ' + state.queue.length + ' รายการ';
            if (firstErr) detail += '\nตัวอย่างข้อผิดพลาด: ' + firstErr;
            setMessage(detail);
            Swal.fire('บันทึกบางรายการไม่สำเร็จ', detail, 'warning');
          }

          setStatus(state.isScanning ? 'กำลังสแกน...' : 'พร้อมเริ่มสแกน', state.isScanning ? 'active' : '');
        } catch (err) {
          setStatus('บันทึกไม่สำเร็จ', 'error');
          setMessage((err && err.message) ? err.message : 'บันทึกไม่สำเร็จ');
          Swal.fire('เกิดข้อผิดพลาด', (err && err.message) ? err.message : 'บันทึกไม่สำเร็จ', 'error');
        } finally {
          state.saving = false;
          state.busy = false;
          refreshButtons();
        }
      }

      function clearQueue() {
        if (!state.queue.length || state.busy || state.saving) return;

        Swal.fire({
          icon: 'question',
          title: 'ล้างรายการที่สแกน?',
          text: 'ระบบจะลบรายการที่ยังไม่บันทึกทั้งหมด',
          showCancelButton: true,
          confirmButtonText: 'ล้างรายการ',
          cancelButtonText: 'ยกเลิก',
          confirmButtonColor: '#dc2626'
        }).then(function (r) {
          if (!r || !r.isConfirmed) return;
          state.queue = [];
          renderQueue();
          setMessage('ล้างรายการแล้ว');
        });
      }

      async function initData() {
        var responses = await Promise.all([
          state.api.me(),
          state.api.storageOptions()
        ]);

        var meRes = responses[0] || {};
        var storageRes = responses[1] || {};

        if (!meRes || meRes.success === false || !meRes.user) {
          C.redirect('index.html', {}, true);
          return false;
        }

        state.user = meRes.user;

        if (state.user.isReadOnly || state.user.canEdit === false) {
          throw new Error('บัญชีผู้มีสิทธิ์อ่าน ไม่สามารถสแกนจัดเก็บเอกสารได้');
        }

        state.storageMaster = (storageRes && storageRes.data && typeof storageRes.data === 'object')
          ? storageRes.data
          : { fiscalYears: [], boxesByFiscalYear: {}, allBoxes: [] };

        return true;
      }

      function teardownScanner() {
        if (!state.html5Qr || !state.isScanning) return Promise.resolve();
        return state.html5Qr.stop().catch(function () {}).then(function () {
          state.isScanning = false;
        });
      }

      async function init() {
        try {
          state.settings = C.ensureSettingsOrThrow();
          state.api = C.createApiClient(state.settings);
        } catch (_e) {
          showError('กรุณาตั้งค่า scriptUrl และ deviceKey ที่หน้า index ก่อน');
          return;
        }

        els.btnBack.onclick = function () { C.redirect('index.html'); };
        els.btnReload.onclick = function () { window.location.reload(); };
        els.btnStart.onclick = function () { startScanner(); };
        els.btnStop.onclick = function () { stopScanner(); };
        els.btnSaveQueue.onclick = function () { saveQueue(); };
        els.btnClearQueue.onclick = function () { clearQueue(); };

        window.addEventListener('beforeunload', function () {
          teardownScanner();
        });

        try {
          var ok = await initData();
          if (!ok) return;
          renderQueue();
          refreshButtons();
          setStatus('พร้อมเริ่มสแกน', '');
          setMessage('');
          els.mainWrap.classList.remove('hidden');
        } catch (err) {
          showError((err && err.message) ? err.message : 'โหลดหน้าสแกนไม่สำเร็จ');
        }
      }

      init();
    })();
  </script>
</body>
</html>
