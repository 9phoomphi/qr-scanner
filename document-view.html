<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>รายละเอียดเอกสาร</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --bg: #f3f6fb;
      --card: rgba(255,255,255,0.9);
      --text: #0f172a;
      --muted: #475569;
      --border: #dbe4f0;
      --primary: #2563eb;
      --primary2: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --warn: #d97706;
      --shadow: 0 18px 46px rgba(15,23,42,0.14);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "IBM Plex Sans Thai", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 540px at 8% -14%, rgba(59,130,246,0.22), rgba(59,130,246,0)), var(--bg);
    }

    .shell { max-width: 1120px; margin: 0 auto; padding: 14px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 14px 16px;
      margin-bottom: 12px;
      backdrop-filter: saturate(160%) blur(8px);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .page-header {
      padding: 12px 14px !important;
    }

    .title {
      margin: 0;
      font-size: clamp(1.15rem, 2vw, 1.35rem);
      font-weight: 820;
      letter-spacing: 0.005em;
      color: #0f172a;
    }

    .page-subtitle {
      margin-top: 2px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #64748b;
    }

    .muted { color: var(--muted); }

    .btn {
      border: none;
      border-radius: 999px;
      height: 38px;
      padding: 0 14px;
      color: #fff;
      font: inherit;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
    }
    .btn.secondary { background: #334155; }
    .btn.success { background: #15803d; }
    .btn.warn { background: #d97706; }
    .btn.danger { background: #dc2626; }
    .btn.outline {
      background: #fff;
      color: var(--primary2);
      border: 1px solid #93c5fd;
    }

    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; }

    .section-title {
      font-size: 0.98rem;
      font-weight: 800;
      color: #334155;
      letter-spacing: 0.01em;
    }

    .section-note {
      margin-top: 6px;
      font-size: 0.88rem;
      color: #64748b;
      font-weight: 560;
    }

    .card.doc-hero {
      border-radius: 24px;
      background:
        radial-gradient(220px 160px at 94% -12%, rgba(59,130,246,0.16), rgba(59,130,246,0)),
        linear-gradient(145deg, rgba(255,255,255,0.78), rgba(255,255,255,0.5)) !important;
      border: 1px solid rgba(148, 163, 184, 0.34) !important;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.11) !important;
      padding: 16px 18px !important;
    }

    .doc-hero-head {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .doc-hero-copy {
      min-width: 0;
      display: grid;
      gap: 4px;
    }

    .doc-hero-kicker {
      font-size: 0.72rem;
      font-weight: 800;
      letter-spacing: 0.13em;
      color: #64748b;
    }

    .doc-hero-title {
      margin: 0;
      font-size: clamp(1.36rem, 2.7vw, 2rem);
      line-height: 1.08;
      font-weight: 900;
      color: #0f172a;
      word-break: break-word;
    }

    .doc-hero-meta {
      font-size: 0.9rem;
      line-height: 1.35;
      color: #475569;
      font-weight: 620;
      word-break: break-word;
    }

    .doc-hero-badges {
      justify-content: flex-end;
      gap: 8px;
    }

    .subject-block {
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(255, 255, 255, 0.66);
    }

    .section-label {
      font-size: 0.74rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-weight: 800;
      color: #64748b !important;
      margin-bottom: 4px;
    }

    .subject-text {
      font-size: clamp(0.98rem, 1.4vw, 1.12rem);
      font-weight: 650;
      line-height: 1.45;
      word-break: break-word;
      color: #0f172a;
    }

    .info-grid {
      gap: 12px;
      margin-top: 10px;
    }

    .info-item {
      min-height: 68px;
      border: 1px solid rgba(203, 213, 225, 0.92);
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.72);
      padding: 10px 12px;
      display: grid;
      align-content: start;
      gap: 4px;
    }

    .label {
      font-size: 0.76rem;
      color: #64748b;
      font-weight: 760;
      margin-bottom: 0;
      letter-spacing: 0.01em;
    }

    .value {
      font-size: 0.95rem;
      font-weight: 650;
      line-height: 1.35;
      color: #0f172a;
      word-break: break-word;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 6px 11px;
      font-size: 0.78rem;
      font-weight: 760;
      border: 1px solid var(--border);
      background: #eef4ff;
      color: #334155;
    }

    .badge.ok { color: #166534; border-color: rgba(22,163,74,.45); background: rgba(22,163,74,.13); }
    .badge.warn { color: #92400e; border-color: rgba(217,119,6,.45); background: rgba(217,119,6,.12); }
    .badge.err { color: #991b1b; border-color: rgba(220,38,38,.45); background: rgba(220,38,38,.12); }
    .badge.info { color: #075985; border-color: rgba(14,165,233,.45); background: rgba(14,165,233,.12); }

    .doc-no-head {
      margin-bottom: 8px;
      padding: 0 !important;
      border: none !important;
      background: transparent !important;
      box-shadow: none !important;
    }

    .step-track {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .step-track .step {
      border: 1px solid var(--border) !important;
      border-radius: 14px !important;
      padding: 10px 9px !important;
      text-align: left;
      background: rgba(248, 251, 255, 0.9) !important;
      min-height: 88px;
      display: grid;
      gap: 3px;
      align-content: start;
    }

    .step-track .step.done {
      border-color: rgba(22,163,74,.45) !important;
      background: rgba(22,163,74,.12) !important;
      color: #166534;
    }

    .step-name {
      font-weight: 800;
      font-size: 0.8rem;
      line-height: 1.2;
      color: #334155;
    }

    .step.done .step-name {
      color: #166534;
    }

    .step-meta {
      font-size: 0.74rem;
      line-height: 1.24;
      color: inherit;
      word-break: break-word;
    }

    .step-pending {
      font-size: 0.74rem;
      margin-top: 3px;
      color: #64748b;
    }

    input, select, textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      min-height: 40px;
      padding: 8px 10px;
      font: inherit;
      color: var(--text);
      background: #fff;
    }

    .row { display: grid; gap: 10px; }
    .row.two { grid-template-columns: repeat(2, minmax(0, 1fr)); }

    .avatar-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px 10px 4px 4px;
      background: #f8fbff;
      font-size: 0.8rem;
      font-weight: 700;
      color: #334155;
      max-width: 100%;
    }
    .avatar-chip img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid rgba(37,99,235,.35);
      flex-shrink: 0;
    }
    .avatar-chip span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .error {
      border: 1px solid rgba(220,38,38,.35);
      background: rgba(220,38,38,.08);
      color: #991b1b;
      border-radius: 10px;
      padding: 10px;
      font-size: 0.9rem;
    }

    .hidden { display: none !important; }

    .qr-card {
      text-align: center;
    }

    #docQr {
      width: min(72vw, 260px);
      max-width: 260px;
      aspect-ratio: 1 / 1;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 4px;
      background: #fff;
      object-fit: contain;
      image-rendering: pixelated;
    }

    body.dark-mode .page-subtitle {
      color: rgba(203, 213, 225, 0.86);
    }

    body.dark-mode .card.doc-hero {
      background:
        radial-gradient(240px 180px at 95% -18%, rgba(56, 189, 248, 0.16), rgba(56, 189, 248, 0)),
        linear-gradient(145deg, rgba(15, 23, 42, 0.88), rgba(15, 23, 42, 0.72)) !important;
      border-color: rgba(148, 163, 184, 0.34) !important;
      box-shadow: 0 22px 48px rgba(2, 8, 20, 0.5) !important;
    }

    body.dark-mode .doc-hero-kicker {
      color: rgba(203, 213, 225, 0.72);
    }

    body.dark-mode .doc-hero-title {
      color: #f8fafc;
    }

    body.dark-mode .doc-hero-meta {
      color: rgba(226, 232, 240, 0.82);
    }

    body.dark-mode .subject-block {
      background: rgba(15, 23, 42, 0.68);
      border-color: rgba(148, 163, 184, 0.32);
    }

    body.dark-mode .subject-text,
    body.dark-mode .value,
    body.dark-mode .section-title {
      color: #e2e8f0;
    }

    body.dark-mode .info-item {
      background: rgba(15, 23, 42, 0.74);
      border-color: rgba(148, 163, 184, 0.3);
    }

    body.dark-mode .label,
    body.dark-mode .section-label,
    body.dark-mode .section-note {
      color: rgba(203, 213, 225, 0.74) !important;
    }

    body.dark-mode .step-track .step {
      background: rgba(15, 23, 42, 0.74) !important;
      border-color: rgba(148, 163, 184, 0.34) !important;
      color: #e2e8f0;
    }

    body.dark-mode .step-track .step.done {
      border-color: rgba(74, 222, 128, 0.46) !important;
      background: rgba(22, 163, 74, 0.2) !important;
      color: #86efac;
    }

    body.dark-mode .step-name {
      color: #e2e8f0;
    }

    body.dark-mode .step-track .step.done .step-name {
      color: #86efac;
    }

    body.dark-mode .step-pending {
      color: rgba(203, 213, 225, 0.66);
    }

    @media (max-width: 900px) {
      .grid-2, .grid-3, .row.two { grid-template-columns: 1fr; }
      .step-track { grid-template-columns: 1fr 1fr; }
      .doc-hero { padding: 14px !important; }
      .doc-hero-badges { width: 100%; justify-content: flex-start; }
      .info-item { min-height: 0; }
    }

    @media (max-width: 560px) {
      .card { padding: 12px; border-radius: 18px; }
      .page-header { padding: 10px 12px !important; }
      .page-subtitle { font-size: 0.82rem; }
      .section-title { font-size: 0.9rem; }
      .subject-text { font-size: 0.94rem; }
      .step-track { grid-template-columns: 1fr; }
    }
  </style>
  <link rel="stylesheet" href="./theme-legacy.css">
</head>
<body>
  <div class="shell">
    <div class="card topbar page-header">
      <div>
        <h1 class="title">รายละเอียดเอกสาร</h1>
        <div class="page-subtitle">Document Control / ข้อมูลแบบละเอียด</div>
      </div>
      <div class="actions">
        <button id="btnBack" class="btn secondary" type="button"><i class="bi bi-arrow-left"></i> กลับ</button>
        <button id="btnReload" class="btn outline" type="button"><i class="bi bi-arrow-clockwise"></i> โหลดใหม่</button>
      </div>
    </div>

    <div id="errBox" class="error hidden"></div>

    <div id="mainWrap" class="hidden">
      <div class="card doc-hero">
        <div class="doc-hero-head">
          <div class="doc-hero-copy">
            <div class="doc-hero-kicker">DOCUMENT DETAIL</div>
            <h2 id="docHeroTitle" class="doc-hero-title">-</h2>
            <div id="docHead" class="doc-hero-meta">กำลังโหลด...</div>
          </div>
          <div class="actions doc-hero-badges" id="statusBadges"></div>
        </div>

        <div class="subject-block">
          <div class="label section-label">เรื่อง</div>
          <div id="subjectText" class="subject-text">-</div>
        </div>

        <div class="grid-3 info-grid" id="baseInfo"></div>
      </div>

      <div class="card">
        <div class="section-title">รายละเอียดเอกสาร</div>
        <div class="grid-3 info-grid" id="detailInfo"></div>
      </div>

      <div class="card">
        <div class="topbar doc-no-head">
          <div class="section-title">เลขที่หนังสือส่งกองคลัง / ลงวันที่ดำเนินการ</div>
          <div class="actions" id="fieldActions"></div>
        </div>
        <div class="grid-2 info-grid" id="docNoInfo"></div>
      </div>

      <div class="card">
        <div class="section-title">ขั้นตอนดำเนินการ</div>
        <div id="stepTrack" class="step-track"></div>
      </div>

      <div class="card" id="storageWrap"></div>

      <div class="card" id="actionWrap"></div>

      <div class="card qr-card">
        <div class="label">QR เอกสาร</div>
        <img id="docQr" alt="QR">
        <div class="actions" style="justify-content:center;margin-top:8px;">
          <button id="btnPrintSticker" class="btn outline" type="button"><i class="bi bi-printer"></i> พิมพ์ใบแปะ</button>
        </div>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script src="./api-client.js"></script>
  <script src="./theme-legacy.js"></script>
  <script src="./app-common.js"></script>
  <script>
    (function () {
      'use strict';

      var C = window.DocFrontendCommon;
      var query = C.parseQuery();
      var docId = C.safeTrim(query.id || '');

      var state = {
        api: null,
        settings: null,
        user: null,
        doc: null,
        statusData: null,
        memberMap: {}
      };

      var els = {
        docHeroTitle: document.getElementById('docHeroTitle'),
        docHead: document.getElementById('docHead'),
        btnBack: document.getElementById('btnBack'),
        btnReload: document.getElementById('btnReload'),
        errBox: document.getElementById('errBox'),
        mainWrap: document.getElementById('mainWrap'),
        statusBadges: document.getElementById('statusBadges'),
        baseInfo: document.getElementById('baseInfo'),
        subjectText: document.getElementById('subjectText'),
        detailInfo: document.getElementById('detailInfo'),
        docNoInfo: document.getElementById('docNoInfo'),
        fieldActions: document.getElementById('fieldActions'),
        stepTrack: document.getElementById('stepTrack'),
        storageWrap: document.getElementById('storageWrap'),
        actionWrap: document.getElementById('actionWrap'),
        docQr: document.getElementById('docQr'),
        btnPrintSticker: document.getElementById('btnPrintSticker')
      };

      function showError(message) {
        var msg = C.safeTrim(message || '');
        if (!msg) {
          els.errBox.classList.add('hidden');
          els.errBox.textContent = '';
          return;
        }
        els.errBox.textContent = msg;
        els.errBox.classList.remove('hidden');
      }

      function statusBadge(doc) {
        var st = C.safeTrim(doc.docStatus || '');
        if (st === 'ยกเลิก') return '<span class="badge err"><i class="bi bi-x-circle"></i> ยกเลิก</span>';
        if (st === 'อนุมัติแล้วส่งคืนเจ้าของเรื่อง') return '<span class="badge"><i class="bi bi-arrow-return-left"></i> ส่งคืนฯ</span>';
        if (st === 'กำลังดำเนินการ') return '<span class="badge info"><i class="bi bi-hourglass-split"></i> กำลังดำเนินการ</span>';
        if (st === 'มอบผู้รับผิดชอบ') return '<span class="badge" style="background:rgba(236,72,153,.12);border-color:rgba(236,72,153,.45);color:#9d174d;"><i class="bi bi-person-check"></i> มอบผู้รับผิดชอบ</span>';
        return '<span class="badge ok"><i class="bi bi-check-circle"></i> ดำเนินการเสร็จ</span>';
      }

      function renderUserChip(name) {
        var key = C.safeTrim(name || '');
        if (!key) return '-';
        var img = state.memberMap[key] || state.memberMap[key.toLowerCase()] || '';
        if (!img) {
          return '<span class="avatar-chip"><img alt="u" src="https://dummyimage.com/24x24/e2e8f0/64748b.png&text=' + encodeURIComponent((key.charAt(0) || '?').toUpperCase()) + '"><span>' + C.escapeHtml(key) + '</span></span>';
        }
        return '<span class="avatar-chip"><img alt="u" src="' + C.escapeHtml(img) + '"><span>' + C.escapeHtml(key) + '</span></span>';
      }

      function getDocQrUrl() {
        var base = C.normalizeScriptUrl(state.settings.scriptUrl || '').split('?')[0];
        var target = base + '?id=' + encodeURIComponent(state.doc.docId || docId) + '&dk=' + encodeURIComponent(state.settings.deviceKey || '');
        return 'https://api.qrserver.com/v1/create-qr-code/?size=1000x1000&margin=0&qzone=2&ecc=Q&data=' + encodeURIComponent(target);
      }

      function renderDoc() {
        var d = state.doc || {};
        var statusData = state.statusData || {};
        var isReadOnly = !!d.isReadOnlyUser;
        var isStored = !!d.isStored;

        els.docHeroTitle.textContent = d.docId || '-';
        els.docHead.textContent = 'เลขรับ ' + (d.receiveNo || '-') + ' • วันที่รับ ' + (d.dateRecDisplay || '-') + ' • เวลา ' + ((d.timeRec || '-') + ' น.');

        var badges = statusBadge(d);
        if (isStored) {
          badges += ' <span class="badge ok"><i class="bi bi-archive"></i> จัดเก็บแล้ว</span>';
        } else {
          badges += ' <span class="badge warn"><i class="bi bi-clock-history"></i> รอจัดเก็บ</span>';
        }
        els.statusBadges.innerHTML = badges;

        var baseRows = [
          ['เลขที่รับ', d.receiveNo || '-'],
          ['วันที่รับ', d.dateRecDisplay || '-'],
          ['เวลา', (d.timeRec || '-') + ' น.'],
          ['เลขที่ สธ.', d.docNoSdh || '-'],
          ['ประเภทเงินงบประมาณ', d.budgetType || '-'],
          ['ปีงบประมาณ', d.fiscalYear || '-']
        ];

        var baseHtml = '';
        for (var i = 0; i < baseRows.length; i++) {
          baseHtml += '<div class="info-item"><div class="label">' + C.escapeHtml(baseRows[i][0]) + '</div><div class="value">' + C.escapeHtml(baseRows[i][1]) + '</div></div>';
        }
        els.baseInfo.innerHTML = baseHtml;

        els.subjectText.textContent = d.subject || '-';

        var detailRows = [
          ['กลุ่ม/ศูนย์', d.group || '-'],
          ['ผู้ส่ง', d.sender || '-'],
          ['วัตถุประสงค์', d.purpose || '-'],
          ['จำนวน', C.fmtMoney(d.amount)],
          ['ส่วนต่าง', C.fmtMoney(d.difference)],
          ['หมายเหตุ', d.statusRemark || '-']
        ];
        var detailHtml = '';
        for (var j = 0; j < detailRows.length; j++) {
          detailHtml += '<div class="info-item"><div class="label">' + C.escapeHtml(detailRows[j][0]) + '</div><div class="value">' + C.escapeHtml(detailRows[j][1]) + '</div></div>';
        }
        els.detailInfo.innerHTML = detailHtml;

        els.docNoInfo.innerHTML = ''
          + '<div class="info-item"><div class="label">เลขที่หนังสือส่งกองคลัง</div><div class="value">' + C.escapeHtml(d.amDocNo || '-') + '</div></div>'
          + '<div class="info-item"><div class="label">ลงวันที่ดำเนินการ</div><div class="value">' + C.escapeHtml(d.anDateDisplay || '-') + '</div></div>';

        var fieldButtons = '';
        if (!isReadOnly) {
          fieldButtons += '<button id="btnEditAm" class="btn outline" type="button"><i class="bi bi-pencil"></i> แก้เลขหนังสือ</button>';
          fieldButtons += '<button id="btnEditAn" class="btn outline" type="button"><i class="bi bi-calendar3"></i> แก้วันที่</button>';
        }
        els.fieldActions.innerHTML = fieldButtons;

        var steps = [
          ['ส่งกลับแก้ไข', statusData.returnCheck, statusData.returnDateDisplay, statusData.returnUser],
          ['รับคืนเอกสาร', statusData.receiveBackCheck, statusData.receiveBackDateDisplay, statusData.receiveBackUser],
          ['ตรวจสอบ', statusData.verifyCheck, statusData.verifyDateDisplay, statusData.verifyUser],
          ['หัวหน้าผ่านงาน', statusData.bossCheck, statusData.bossDateDisplay, statusData.bossUser],
          ['เสนอลงนาม', statusData.signCheck, statusData.signDateDisplay, statusData.signUser]
        ];

        var stepHtml = '';
        for (var k = 0; k < steps.length; k++) {
          var done = !!steps[k][1];
          stepHtml += '<div class="step ' + (done ? 'done' : '') + '">';
          stepHtml += '<div class="step-name">' + C.escapeHtml(steps[k][0]) + '</div>';
          if (done) {
            stepHtml += '<div class="step-meta">' + C.escapeHtml(steps[k][2] || '-') + '</div>';
            stepHtml += '<div class="step-meta">' + C.escapeHtml(steps[k][3] || '-') + '</div>';
          } else {
            stepHtml += '<div class="step-pending">ยังไม่ดำเนินการ</div>';
          }
          stepHtml += '</div>';
        }
        els.stepTrack.innerHTML = stepHtml;

        if (isStored) {
          els.storageWrap.innerHTML = ''
            + '<div class="section-title">ข้อมูลการจัดเก็บ</div>'
            + '<div class="grid-2 info-grid">'
            + '<div class="info-item"><div class="label">สถานที่เก็บ</div><div class="value">' + C.escapeHtml(d.storedLoc || '-') + '</div></div>'
            + '<div class="info-item"><div class="label">ผู้จัดเก็บ</div><div class="value">' + renderUserChip(d.storedUser || '-') + '</div></div>'
            + '<div class="info-item"><div class="label">วันที่จัดเก็บ</div><div class="value">' + C.escapeHtml(d.storedAtDisplay || '-') + '</div></div>'
            + '<div class="info-item"><div class="label">ครบกำหนดทำลาย</div><div class="value">' + C.escapeHtml(d.destroyDateDisplay || '-') + '</div></div>'
            + '</div>';
        } else {
          var canStore = !isReadOnly && d.docStatus !== 'ยกเลิก' && d.docStatus !== 'อนุมัติแล้วส่งคืนเจ้าของเรื่อง' && d.docStatus !== 'กำลังดำเนินการ' && d.docStatus !== 'มอบผู้รับผิดชอบ';
          if (!canStore) {
            els.storageWrap.innerHTML = '<div class="section-title">การจัดเก็บเอกสาร</div><div class="section-note">เอกสารสถานะนี้ยังไม่สามารถจัดเก็บได้</div>';
          } else {
            els.storageWrap.innerHTML = ''
              + '<div class="section-title">การจัดเก็บเอกสาร</div>'
              + '<div class="section-note">ใช้หน้าสแกนกลางเพื่อจัดเก็บเอกสารเป็นชุด</div>'
              + '<div class="actions" style="margin-top:8px;">'
              + '<button id="btnGoScanner" class="btn success" type="button"><i class="bi bi-upc-scan"></i> ไปหน้าสแกนจัดเก็บ</button>'
              + '</div>';
          }
        }

        var actionHtml = '<div class="section-title">จัดการเอกสาร</div><div class="actions" style="margin-top:8px;">';
        if (!isReadOnly) {
          actionHtml += '<button id="btnEdit" class="btn outline" type="button"><i class="bi bi-pencil"></i> แก้ไขเอกสาร</button>';
          actionHtml += '<button id="btnStatus" class="btn outline" type="button"><i class="bi bi-list-check"></i> จัดการสถานะ</button>';
          actionHtml += '<button id="btnMainStatus" class="btn warn" type="button"><i class="bi bi-arrow-repeat"></i> เปลี่ยนสถานะหลัก</button>';
        }
        actionHtml += '</div>';
        els.actionWrap.innerHTML = actionHtml;

        els.docQr.src = getDocQrUrl();

        bindActionEvents();
      }

      function bindActionEvents() {
        var d = state.doc || {};

        var btnEdit = document.getElementById('btnEdit');
        if (btnEdit) {
          btnEdit.onclick = function () {
            C.redirect('document-form.html', { mode: 'edit', id: d.docId });
          };
        }

        var btnStatus = document.getElementById('btnStatus');
        if (btnStatus) {
          btnStatus.onclick = function () {
            C.redirect('document-status.html', { id: d.docId });
          };
        }

        var btnMainStatus = document.getElementById('btnMainStatus');
        if (btnMainStatus) {
          btnMainStatus.onclick = changeMainStatus;
        }

        var btnGoScanner = document.getElementById('btnGoScanner');
        if (btnGoScanner) {
          btnGoScanner.onclick = function () {
            C.redirect('storage-box-scan.html');
          };
        }

        var btnEditAm = document.getElementById('btnEditAm');
        if (btnEditAm) {
          btnEditAm.onclick = function () { editField('amDocNo', 'แก้ไขเลขที่หนังสือส่งกองคลัง', d.amDocNo || ''); };
        }

        var btnEditAn = document.getElementById('btnEditAn');
        if (btnEditAn) {
          btnEditAn.onclick = function () { editField('anDate', 'แก้ไขลงวันที่ดำเนินการ (YYYY-MM-DD)', d.anDateInput || ''); };
        }
      }

      async function changeMainStatus() {
        var result = await Swal.fire({
          title: 'เปลี่ยนสถานะเอกสาร',
          html: ''
            + '<div style="text-align:left;">'
            + '<label class="label">สถานะ</label>'
            + '<select id="swMainStatus">'
            + '<option value="">-- เลือกสถานะ --</option>'
            + '<option value="ดำเนินการเสร็จ">ดำเนินการเสร็จ</option>'
            + '<option value="กำลังดำเนินการ">กำลังดำเนินการ</option>'
            + '<option value="มอบผู้รับผิดชอบ">มอบผู้รับผิดชอบ</option>'
            + '<option value="ยกเลิก">ยกเลิก</option>'
            + '<option value="อนุมัติแล้วส่งคืนเจ้าของเรื่อง">อนุมัติแล้วส่งคืนเจ้าของเรื่อง</option>'
            + '</select>'
            + '<label class="label" style="margin-top:8px;">หมายเหตุ (ไม่บังคับ)</label>'
            + '<textarea id="swMainRemark" rows="3" placeholder="หมายเหตุ"></textarea>'
            + '</div>',
          showCancelButton: true,
          confirmButtonText: 'บันทึก',
          cancelButtonText: 'ยกเลิก',
          preConfirm: function () {
            var st = C.safeTrim(document.getElementById('swMainStatus').value);
            if (!st) {
              Swal.showValidationMessage('กรุณาเลือกสถานะ');
              return false;
            }
            return {
              status: st,
              remark: C.safeTrim(document.getElementById('swMainRemark').value)
            };
          }
        });

        if (!result || !result.isConfirmed || !result.value) return;

        try {
          var res = await state.api.docChangeMainStatus(state.doc.docId, result.value.status, result.value.remark);
          if (!res || res.success === false) throw new Error((res && res.error) ? res.error : 'บันทึกไม่สำเร็จ');
          Swal.fire('สำเร็จ', 'เปลี่ยนสถานะเรียบร้อย', 'success');
          await loadDetail();
        } catch (err) {
          Swal.fire('เกิดข้อผิดพลาด', (err && err.message) ? err.message : 'บันทึกไม่สำเร็จ', 'error');
        }
      }

      async function editField(fieldName, title, currentValue) {
        var result = await Swal.fire({
          title: title,
          input: 'text',
          inputValue: C.safeText(currentValue || ''),
          showCancelButton: true,
          confirmButtonText: 'บันทึก',
          cancelButtonText: 'ยกเลิก'
        });

        if (!result || !result.isConfirmed) return;

        try {
          var res = await state.api.docUpdateField(state.doc.docId, fieldName, C.safeText(result.value || ''));
          if (!res || res.success === false) throw new Error((res && res.error) ? res.error : 'บันทึกไม่สำเร็จ');
          Swal.fire('สำเร็จ', 'บันทึกข้อมูลเรียบร้อย', 'success');
          await loadDetail();
        } catch (err) {
          Swal.fire('เกิดข้อผิดพลาด', (err && err.message) ? err.message : 'บันทึกไม่สำเร็จ', 'error');
        }
      }

      function printSticker() {
        var d = state.doc || {};
        var qr = getDocQrUrl();
        var w = window.open('', '', 'width=920,height=1200');
        if (!w) {
          Swal.fire('ไม่สามารถเปิดหน้าต่างพิมพ์', 'กรุณาอนุญาต Pop-up', 'info');
          return;
        }

        var esc = C.escapeHtml;
        var h = '';
        h += '<!doctype html><html><head><meta charset="utf-8"><title>ใบแปะเอกสาร</title>';
        h += '<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;700;800&display=swap" rel="stylesheet">';
        h += '<style>@page{size:A4 portrait;margin:8mm}body{font-family:"IBM Plex Sans Thai",sans-serif;margin:0;padding:0;color:#0f172a}.sheet{max-width:194mm;margin:0 auto}.label{border:2px solid #0f172a;border-radius:16px;padding:10px}table{width:100%;border-collapse:collapse;margin-top:10px}td{border:1px solid #cbd5e1;padding:6px 8px;font-size:10.5pt}td.head{width:35%;background:#f8fafc;font-weight:800;color:#334155}.subj{margin-top:10px;border:1px solid #cbd5e1;border-radius:12px;padding:8px;background:#f8fafc}.no-print{text-align:center;margin-top:10px}@media print{.no-print{display:none!important}}</style>';
        h += '</head><body><div class="sheet"><div class="label">';
        h += '<div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start"><div><div style="font-size:18pt;font-weight:900">ใบแปะหน้าเอกสาร</div><div style="font-size:10pt;color:#334155">สแกนเพื่อดูรายละเอียดเอกสาร</div></div><img src="' + esc(qr) + '" style="width:48mm;height:48mm;border:1px solid #cbd5e1;border-radius:12px;padding:2px;background:#fff"></div>';
        h += '<table>';
        h += '<tr><td class="head">เลขที่เอกสาร</td><td>' + esc(d.docId || '-') + '</td></tr>';
        h += '<tr><td class="head">เลขที่รับ</td><td>' + esc(d.receiveNo || '-') + '</td></tr>';
        h += '<tr><td class="head">เลขที่ สธ.</td><td>' + esc(d.docNoSdh || '-') + '</td></tr>';
        h += '<tr><td class="head">เลขที่หนังสือส่งกองคลัง</td><td>' + esc(d.amDocNo || '-') + '</td></tr>';
        h += '<tr><td class="head">วันที่รับเอกสาร</td><td>' + esc(d.dateRecDisplay || '-') + '</td></tr>';
        h += '<tr><td class="head">กลุ่ม/ศูนย์</td><td>' + esc(d.group || '-') + '</td></tr>';
        h += '<tr><td class="head">ผู้ส่ง</td><td>' + esc(d.sender || '-') + '</td></tr>';
        h += '<tr><td class="head">วัตถุประสงค์</td><td>' + esc(d.purpose || '-') + '</td></tr>';
        h += '<tr><td class="head">ประเภทเงินงบประมาณ</td><td>' + esc(d.budgetType || '-') + '</td></tr>';
        h += '<tr><td class="head">สถานะ</td><td>' + esc(d.docStatus || '-') + '</td></tr>';
        h += '</table>';
        h += '<div class="subj"><div style="font-size:8pt;font-weight:800;color:#475569">เรื่อง</div><div style="font-size:10.5pt;line-height:1.4">' + esc(d.subject || '-') + '</div></div>';
        h += '</div><div class="no-print"><button onclick="window.print()" style="padding:10px 26px;border:1px solid rgba(10,132,255,.42);border-radius:999px;background:linear-gradient(180deg,#3299ff,#0a84ff);color:#fff;font-weight:760;box-shadow:0 10px 22px rgba(10,132,255,.22);cursor:pointer">พิมพ์ใบแปะ</button></div></div></body></html>';

        w.document.write(h);
        w.document.close();
      }

      async function loadDetail() {
        showError('');
        els.mainWrap.classList.add('hidden');

        try {
          var data = await Promise.all([
            state.api.docDetail(docId),
            state.api.optionsMembers(),
            state.api.me()
          ]);

          var detailRes = data[0] || {};
          var membersRes = data[1] || {};
          var meRes = data[2] || {};

          if (!meRes || meRes.success === false || !meRes.user) {
            C.redirect('index.html', {}, true);
            return;
          }

          if (!detailRes || detailRes.success === false || !detailRes.doc) {
            throw new Error((detailRes && detailRes.error) ? detailRes.error : 'ไม่พบเอกสาร');
          }

          state.user = meRes.user;
          state.doc = detailRes.doc;
          state.statusData = detailRes.statusData || {};

          state.memberMap = {};
          var members = (membersRes && membersRes.data && Array.isArray(membersRes.data)) ? membersRes.data : [];
          for (var i = 0; i < members.length; i++) {
            var m = members[i] || {};
            var name = C.safeTrim(m.name || '');
            var img = C.safeTrim(m.image || '');
            if (!name || !img) continue;
            state.memberMap[name] = img;
            state.memberMap[name.toLowerCase()] = img;
          }

          renderDoc();
          els.mainWrap.classList.remove('hidden');
        } catch (err) {
          showError((err && err.message) ? err.message : 'โหลดข้อมูลเอกสารไม่สำเร็จ');
        }
      }

      function init() {
        if (!docId) {
          showError('ไม่พบพารามิเตอร์ id');
          return;
        }

        try {
          state.settings = C.ensureSettingsOrThrow();
          state.api = C.createApiClient(state.settings);
        } catch (_e) {
          showError('กรุณาตั้งค่า scriptUrl และ deviceKey ที่หน้า index ก่อน');
          return;
        }

        els.btnBack.onclick = function () {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            C.redirect('index.html');
          }
        };

        els.btnReload.onclick = function () {
          loadDetail();
        };

        els.btnPrintSticker.onclick = function () {
          printSticker();
        };

        loadDetail();
      }

      init();
    })();
  </script>
</body>
</html>
